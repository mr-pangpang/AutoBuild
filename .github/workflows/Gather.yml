name: Gather
on:
  schedule:
    - cron: "0 */2 * * *"
  workflow_dispatch:

jobs:
  download-and-save:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–å½“å‰ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: ä»æŒ‡å®šé“¾æ¥ä¸‹è½½ Gatherï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
        run: |
          echo "å¼€å§‹ä¸‹è½½ Gather æ–‡ä»¶..."
          
          # æ–¹æ³•1ï¼šä½¿ç”¨ curl å¸¦æµè§ˆå™¨å¤´éƒ¨ä¿¡æ¯
          echo "å°è¯•æ–¹æ³•1: curl..."
          curl -f -L --retry 3 --retry-delay 5 -o Gather \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
            -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8" \
            -H "Accept-Language: zh-CN,zh;q=0.9,en;q=0.8" \
            -H "Referer: https://tv.iill.top/" \
            "https://tv.iill.top/m3u/Gather"
          
          if [ $? -eq 0 ] && [ -s Gather ]; then
            echo "âœ… æ–¹æ³•1ä¸‹è½½æˆåŠŸ"
            DOWNLOAD_SUCCESS=true
          else
            echo "âŒ æ–¹æ³•1ä¸‹è½½å¤±è´¥ï¼Œå°è¯•æ–¹æ³•2..."
            DOWNLOAD_SUCCESS=false
            
            # æ–¹æ³•2ï¼šä½¿ç”¨ wget
            wget -O Gather \
              --user-agent="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
              --header="Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8" \
              "https://tv.iill.top/m3u/Gather"
            
            if [ $? -eq 0 ] && [ -s Gather ]; then
              echo "âœ… æ–¹æ³•2ä¸‹è½½æˆåŠŸ"
              DOWNLOAD_SUCCESS=true
            else
              echo "âŒ æ–¹æ³•2ä¸‹è½½å¤±è´¥ï¼Œå°è¯•æ–¹æ³•3..."
              
              # æ–¹æ³•3ï¼šä½¿ç”¨ Python
              python3 -c "
              import urllib.request
              import urllib.error
              try:
                  opener = urllib.request.build_opener()
                  opener.addheaders = [
                      ('User-Agent', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'),
                      ('Accept', 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8'),
                      ('Referer', 'https://tv.iill.top/')
                  ]
                  urllib.request.install_opener(opener)
                  urllib.request.urlretrieve('https://tv.iill.top/m3u/Gather', 'Gather')
                  print('Pythonä¸‹è½½æˆåŠŸ')
              except Exception as e:
                  print(f'Pythonä¸‹è½½å¤±è´¥: {e}')
                  exit(1)
              "
              
              if [ $? -eq 0 ] && [ -s Gather ]; then
                echo "âœ… æ–¹æ³•3ä¸‹è½½æˆåŠŸ"
                DOWNLOAD_SUCCESS=true
              else
                echo "âŒ æ‰€æœ‰ä¸‹è½½æ–¹æ³•éƒ½å¤±è´¥"
                DOWNLOAD_SUCCESS=false
              fi
            fi
          fi
          
          if [ "$DOWNLOAD_SUCCESS" = true ]; then
            echo "ğŸ“Š ä¸‹è½½å®Œæˆï¼Œæ–‡ä»¶ä¿¡æ¯ï¼š"
            echo "æ–‡ä»¶å¤§å°: $(du -h Gather | cut -f1)"
            echo "æ–‡ä»¶ç±»å‹: $(file -b Gather)"
            echo "å‰100ä¸ªå­—ç¬¦é¢„è§ˆ:"
            head -c 100 Gather | cat -A
            echo ""
          else
            echo "ğŸ’¥ ä¸‹è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥é“¾æ¥æ˜¯å¦æœ‰æ•ˆæˆ–éœ€è¦ç‰¹æ®Šè®¤è¯"
            exit 1
          fi

      - name: éªŒè¯ä¸‹è½½çš„æ–‡ä»¶
        run: |
          if [ ! -f Gather ]; then
            echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          if [ ! -s Gather ]; then
            echo "âŒ æ–‡ä»¶ä¸ºç©º"
            exit 1
          fi
          
          FILESIZE=$(stat -c%s Gather)
          if [ "$FILESIZE" -lt 100 ]; then
            echo "âš ï¸ æ–‡ä»¶å¤§å°å¼‚å¸¸å°ï¼Œå¯èƒ½æ˜¯é”™è¯¯é¡µé¢"
            cat Gather
            exit 1
          fi
          
          echo "âœ… æ–‡ä»¶éªŒè¯é€šè¿‡"
          echo "æ–‡ä»¶å¤§å°: $FILESIZE å­—èŠ‚"

      - name: æ£€æŸ¥dpdisk/fileä»“åº“æ˜¯å¦å­˜åœ¨
        id: check_repo
        run: |
          echo "æ£€æŸ¥ç›®æ ‡ä»“åº“æ˜¯å¦å­˜åœ¨..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token ${{ secrets.PANGPANG }}" "https://api.github.com/repos/dpdisk/file")
          echo "HTTPçŠ¶æ€ç : $RESPONSE"
          echo "repo_exists=$([ "$RESPONSE" -eq 200 ] && echo "true" || echo "false")" >> $GITHUB_OUTPUT

      - name: è‹¥ä»“åº“ä¸å­˜åœ¨åˆ™åˆ›å»º
        if: steps.check_repo.outputs.repo_exists == 'false'
        run: |
          echo "åˆ›å»ºæ–°ä»“åº“..."
          curl -X POST \
            -H "Authorization: token ${{ secrets.PANGPANG }}" \
            -H "Content-Type: application/json" \
            -d '{"name":"file","auto_init":true,"visibility":"public"}' \
            "https://api.github.com/user/repos"
          echo "ä»“åº“åˆ›å»ºå®Œæˆ"

      - name: å…‹éš†dpdisk/fileä»“åº“
        run: |
          echo "å…‹éš†ç›®æ ‡ä»“åº“..."
          git clone -b main --single-branch https://${{ secrets.PANGPANG }}@github.com/dpdisk/file.git target-repo || \
          (mkdir -p target-repo && cd target-repo && git init && git remote add origin https://${{ secrets.PANGPANG }}@github.com/dpdisk/file.git && git checkout -b main)
          echo "å…‹éš†å®Œæˆ"

      - name: ç§»åŠ¨æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“æ ¹ç›®å½•
        run: |
          echo "ç§»åŠ¨æ–‡ä»¶åˆ°ç›®æ ‡ä»“åº“..."
          mv Gather target-repo/
          ls -la target-repo/
          echo "âœ… æ–‡ä»¶å·²ç§»åŠ¨åˆ°ï¼štarget-repo/Gather"

      - name: æäº¤å¹¶æ¨é€dpdiskä»“åº“å˜æ›´
        run: |
          echo "æäº¤å˜æ›´..."
          cd target-repo
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add Gather
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff-index --quiet HEAD --; then
            echo "ğŸ”„ æ— æ–‡ä»¶å˜æ›´ï¼Œæ— éœ€æäº¤"
          else
            CURRENT_TIME=$(date -d "+8 hours" +'%Y-%m-%d %H:%M:%S')
            git commit -m "è‡ªåŠ¨æ›´æ–°: $CURRENT_TIME"
            echo "âœ… æäº¤å®Œæˆ: $CURRENT_TIME"
          fi

      - name: æ¨é€åˆ°è¿œç¨‹ä»“åº“
        run: |
          cd target-repo
          echo "æ¨é€å˜æ›´åˆ°è¿œç¨‹ä»“åº“..."
          git push https://${{ secrets.PANGPANG }}@github.com/dpdisk/file.git HEAD:main
          echo "âœ… æ¨é€å®Œæˆ"

      - name: æ¸…ç†å·¥ä½œåŒº
        if: always()
        run: |
          echo "æ¸…ç†å·¥ä½œåŒº..."
          rm -rf target-repo/ || true
          echo "æ¸…ç†å®Œæˆ"
