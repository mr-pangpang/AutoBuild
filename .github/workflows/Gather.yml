name: AutoBuild DiskTV
on:
  schedule:
    - cron: "0 */2 * * *"  # 每两小时执行（分钟 小时 日 月 周）
  workflow_dispatch:  # 手动触发

jobs:
  download-and-save:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取当前仓库代码
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: 从指定链接下载TV.txt
        run: |
          curl -f -o TV.txt "http://123.56.43.183/tv/TV.txt"
          echo "下载完成，文件大小：$(du -h TV.txt)"

      - name: 检查dpdisk/file仓库是否存在
        id: check_repo
        run: |
          RESPONSE=$(curl -s -w "%{http_code}" -H "Authorization: token ${{ secrets.PANGPANG }}" "https://api.github.com/repos/dpdisk/file")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          echo "repo_exists=$([ "$HTTP_CODE" -eq 200 ] && echo "true" || echo "false")" >> $GITHUB_OUTPUT

      - name: 若仓库不存在则创建（不初始化README）
        if: steps.check_repo.outputs.repo_exists == 'false'
        run: |
          # 修复1：规范反斜杠换行，确保命令衔接无空格；修复2：补充visibility参数（GitHub API必填）
          curl -X POST \
            -H "Authorization: token ${{ secrets.PANGPANG }}" \
            -H "Content-Type: application/json" \
            -d '{"name": "file", "auto_init": false, "visibility": "public"}' \  # 公开仓库用public，私有用private
            "https://api.github.com/user/repos"

      - name: 克隆dpdisk/file仓库（空仓库首次克隆需指定分支）
        run: |
          git clone -b main --single-branch https://${{ secrets.PANGPANG }}@github.com/dpdisk/file.git target-repo || (mkdir -p target-repo && cd target-repo && git init && git remote add origin https://${{ secrets.PANGPANG }}@github.com/dpdisk/file.git && git checkout -b main)

      - name: 移动文件到目标仓库根目录（不创建file子文件夹）
        run: |
          mv TV.txt target-repo/
          echo "文件已移动到：target-repo/TV.txt"

      - name: 提交并推送dpdisk仓库变更
        run: |
          cd target-repo
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add TV.txt
          git commit -m "定时下载并保存TV.txt（$(date +%Y-%m-%d_%H:%M:%S)）" || echo "无文件变更，无需提交"
          git push https://${{ secrets.PANGPANG }}@github.com/dpdisk/file.git HEAD:main
