name: Auto Gather & Update TV Content
on:
  schedule:
    - cron: "0 */6 * * *"  # UTCæ¯6å°æ—¶æ‰§è¡Œ
  workflow_dispatch:
    inputs:
      reason:
        description: "æ‰‹åŠ¨è§¦å‘åŸå› "
        required: false
        default: "æ‰‹åŠ¨æ›´æ–°TVå†…å®¹"

jobs:
  gather-tv-content:
    runs-on: windows-latest
    steps:
      - name: Checkout Repository Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ğŸ‘‡ ä¼˜åŒ–åçš„è„šæœ¬æ‰§è¡Œæ­¥éª¤ï¼ˆå«å®Œæ•´æ—¥å¿—ï¼‰ğŸ‘‡
      - name: Run Gather.bat & Show Full Logs
        working-directory: ./script
        run: |
          echo "=== 1. ç›®å½•ç»“æ„æ£€æŸ¥ ==="
          echo "Scriptç›®å½•æ–‡ä»¶ï¼š"
          dir
          echo "`nTVç›®å½•æ–‡ä»¶ï¼ˆä¸Šçº§ç›®å½•ï¼‰ï¼š"
          dir ../TV 2>&1 || echo "TVç›®å½•æš‚æœªåˆ›å»º"  # å…è®¸ç›®å½•ä¸å­˜åœ¨ï¼Œä¸æŠ¥é”™
          
          echo "`n=== 2. æ‰§è¡ŒGather.bat ==="
          cmd /c .\Gather.bat
          $batExitCode = $LASTEXITCODE
          echo "Gather.bat é”™è¯¯ç ï¼š$batExitCode"
          
          echo "`n=== 3. å®Œæ•´è„šæœ¬æ—¥å¿— ==="
          if (Test-Path "fetch-tv-log.txt") {
            Get-Content "fetch-tv-log.txt" -Raw
          } else {
            echo "ERROR: æ—¥å¿—æ–‡ä»¶ç¼ºå¤±ï¼Œè„šæœ¬æœªå¯åŠ¨ï¼"
            exit 1
          }
          
          if ($batExitCode -ne 0) {
            echo "`n=== è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œç»ˆæ­¢ ==="
            exit 1
          }

      - name: Commit & Push tv.txt
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          if (Test-Path "../TV/tv.txt") {
            $fileSize = (Get-Item "../TV/tv.txt").Length
            if ($fileSize -eq 0) {
              echo "è­¦å‘Šï¼štv.txtä¸ºç©ºæ–‡ä»¶ï¼Œä¸æäº¤ï¼"
              exit 1
            }
            git add ../TV/tv.txt
            $commitMsg = "Auto update TV content (UTC: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss'))"
            git diff --cached --quiet || (git commit -m "$commitMsg" && echo "æäº¤æˆåŠŸï¼š$commitMsg")
          } else {
            echo "è­¦å‘Šï¼šæœªæ‰¾åˆ°tv.txtï¼ŒæŠ“å–å¤±è´¥ï¼"
            exit 1
          }
          
          git push origin main --force-with-lease
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify on Failure
        if: failure()
        run: |
          echo "å·¥ä½œæµå¤±è´¥ï¼è¯·é‡ç‚¹æŸ¥çœ‹ã€ŒRun Gather.bat & Show Full Logsã€æ­¥éª¤çš„è„šæœ¬æ—¥å¿—ï¼Œå®šä½PowerShellæˆ–è·¯å¾„é—®é¢˜"
