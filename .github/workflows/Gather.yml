name: Gather TV Source & Push to Second Repo
on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 8 * * *'  # åŒ—äº¬æ—¶é—´æ¯æ—¥8ç‚¹è‡ªåŠ¨è¿è¡Œï¼ˆå¯é€‰ï¼‰

jobs:
  sync-tv-source:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      # æ­¥éª¤1ï¼šæ‹‰å–ç¬¬ä¸€ä»“åº“ä»£ç ï¼ˆæ— ä¾èµ–å¯åˆ é™¤ï¼‰
      - name: Checkout First Repo Code
        uses: actions/checkout@v4
        with:
          repository: mr-pangpang/AutoBuild
          fetch-depth: 1

      # æ­¥éª¤2ï¼šå®‰è£…ä¾èµ–ï¼ˆç¡®ä¿curlå¯ç”¨ï¼‰
      - name: Install Dependencies
        run: sudo apt update && sudo apt install -y curl

      # æ­¥éª¤3ï¼šä¸‹è½½TV.txtï¼ˆå¢åŠ ä¸‹è½½å¤±è´¥é‡è¯•+æ–‡ä»¶å¤§å°æ£€æŸ¥ï¼‰
      - name: Download TV.txt from Source URL
        run: |
          mkdir -p ./temp  # ç¡®ä¿ä¸´æ—¶ç›®å½•å­˜åœ¨
          # 3æ¬¡é‡è¯•ä¸‹è½½ï¼Œé¿å…ç½‘ç»œæ³¢åŠ¨
          curl -sSL --retry 3 --output ./temp/tv.txt "http://123.56.43.183/tv/TV.txt"
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”éç©º
          if [ ! -f ./temp/tv.txt ]; then
            echo "Error: TV.txt not found after download"
            exit 1
          fi
          if [ $(stat -c %s ./temp/tv.txt) -eq 0 ]; then
            echo "Error: TV.txt is empty"
            exit 1
          fi
          echo "âœ… TV.txt downloaded successfully (size: $(du -sh ./temp/tv.txt | awk '{print $1}'))"

      # æ­¥éª¤4ï¼šæ¨é€æ–‡ä»¶åˆ°ç¬¬äºŒä»“åº“ï¼ˆå¢åŠ è·¯å¾„æ£€æŸ¥+å¼ºåˆ¶æäº¤ï¼‰
      - name: Push TV.txt to Second Repository (dpdisk/file)
        env:
          SECOND_REPO_TOKEN: ${{ secrets.PANGPANG }}
          SECOND_REPO_URL: "https://github.com/dpdisk/file.git"
          SECOND_REPO_BRANCH: "main"  # è‹¥ç¬¬äºŒä»“åº“åˆ†æ”¯æ˜¯masterï¼Œæ”¹ä¸ºmaster
        run: |
          # é…ç½®Gitèº«ä»½
          git config --global user.name "GitHub Actions (AutoSync)"
          git config --global user.email "actions-auto-sync@example.com"

          # å…‹éš†ç¬¬äºŒä»“åº“ï¼ˆå¸¦Tokenæˆæƒï¼‰
          echo "ğŸ” Cloning second repository: $SECOND_REPO_URL"
          git clone "https://${SECOND_REPO_TOKEN}@${SECOND_REPO_URL#https://}" ./second-repo
          if [ $? -ne 0 ]; then
            echo "Error: Failed to clone second repository"
            exit 1
          fi

          # è¿›å…¥ç¬¬äºŒä»“åº“ç›®å½•ï¼Œæ£€æŸ¥å¹¶å¤åˆ¶æ–‡ä»¶
          cd ./second-repo
          echo "ğŸ“‚ Current files in second repo: $(ls -l)"
          
          # æ£€æŸ¥æºæ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå†å¤åˆ¶
          if [ ! -f ../temp/tv.txt ]; then
            echo "Error: Source file ../temp/tv.txt missing"
            exit 1
          fi
          rm -f tv.txt  # åˆ é™¤æ—§æ–‡ä»¶ï¼ˆè‹¥å­˜åœ¨ï¼‰
          cp ../temp/tv.txt ./tv.txt  # å¤åˆ¶æ–°æ–‡ä»¶
          
          # éªŒè¯å¤åˆ¶ç»“æœ
          if [ ! -f tv.txt ]; then
            echo "Error: Failed to copy tv.txt to second repo"
            exit 1
          else
            echo "âœ… tv.txt copied to second repo (size: $(du -sh tv.txt | awk '{print $1}'))"
          fi

          # å¼ºåˆ¶æäº¤ï¼ˆè·³è¿‡å˜æ›´æ£€æŸ¥ï¼Œç¡®ä¿é¦–æ¬¡æ¨é€æˆåŠŸï¼‰
          git add tv.txt
          # å¤„ç†ç©ºæäº¤ï¼ˆè‹¥æ–‡ä»¶æ— å˜æ›´ï¼Œé¿å…æŠ¥é”™ï¼‰
          if git diff --cached --quiet; then
            echo "â„¹ï¸ tv.txt content unchanged, no push needed"
            exit 0
          fi
          git commit -m "Auto-Sync: Update TV source ($(date +'%Y-%m-%d %H:%M:%S'))"
          echo "ğŸš€ Pushing to $SECOND_REPO_BRANCH branch..."
          git push origin $SECOND_REPO_BRANCH
          
          # éªŒè¯æ¨é€ç»“æœ
          if [ $? -eq 0 ]; then
            echo "âœ… Success: tv.txt pushed to second repository"
          else
            echo "Error: Failed to push to second repository"
            exit 1
          fi

      # æ­¥éª¤5ï¼šæ¸…ç†ä¸´æ—¶æ–‡ä»¶
      - name: Clean Up
        if: always()
        run: rm -rf ./temp ./second-repo
        echo "ğŸ§¹ Temporary files cleaned up"
