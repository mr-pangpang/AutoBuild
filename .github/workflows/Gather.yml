name: Auto Gather & Update TV Content
on:
  schedule:
    - cron: "0 */6 * * *"  # UTCæ—¶åŒºï¼Œæ¯6å°æ—¶æ‰§è¡Œ
  workflow_dispatch:
    inputs:
      reason:
        description: "æ‰‹åŠ¨è§¦å‘åŸå› "
        required: false
        default: "æ‰‹åŠ¨æ›´æ–°TVå†…å®¹"

jobs:
  gather-tv-content:
    runs-on: windows-latest
    steps:
      - name: Checkout Repository Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ğŸ‘‡ æ›¿æ¢ä¸ºä¿®å¤åçš„curlå®‰è£…æ­¥éª¤ ğŸ‘‡
      - name: Install & Configure curl
        run: |
          Invoke-WebRequest -Uri "https://curl.se/windows/dl-8.9.1/curl-8.9.1_1-win64-mingw.zip" -OutFile "curl.zip" -UseBasicParsing
          Expand-Archive -Path "curl.zip" -DestinationPath "C:\curl" -Force
          $curlFolder = Get-ChildItem -Path "C:\curl" -Directory | Select-Object -First 1 | ForEach-Object { $_.FullName }
          echo "$curlFolder\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8
          curl --version
        shell: pwsh

      - name: Run Gather.bat to Fetch Content
        working-directory: ./script
        run: |
          echo "å½“å‰å·¥ä½œç›®å½•ï¼š$(Get-Location)"
          cmd /c .\Gather.bat
          if (Test-Path "fetch-tv-log.txt") {
            echo "===== Gather.bat æ‰§è¡Œæ—¥å¿— ====="
            Get-Content "fetch-tv-log.txt"
            echo "=============================="
          }

      - name: Commit & Push tv.txt to Repository
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          if (Test-Path "../TV/tv.txt") {
            git add ../TV/tv.txt
            $commitMsg = "Auto update TV content (scheduled at $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC'))"
            git diff --cached --quiet || (git commit -m "$commitMsg" && echo "æäº¤æˆåŠŸï¼š$commitMsg")
          } else {
            echo "è­¦å‘Šï¼šæœªæ‰¾åˆ°tv.txtæ–‡ä»¶ï¼ŒæŠ“å–å¤±è´¥"
            exit 1
          }
          git push origin main --force-with-lease
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify on Failure
        if: failure()
        run: |
          echo "å·¥ä½œæµæ‰§è¡Œå¤±è´¥ï¼è¯·æŸ¥çœ‹ã€ŒRun Gather.bat to Fetch Contentã€æ­¥éª¤æ—¥å¿—"
