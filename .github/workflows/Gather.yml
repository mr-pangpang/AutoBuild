name: Auto-Sync TV Source to Second Repo
# è§¦å‘æœºåˆ¶ï¼šæ‰‹åŠ¨è§¦å‘ + æ¯æ—¥å®šæ—¶ï¼ˆåŒ—äº¬æ—¶é—´8ç‚¹ï¼Œå¯æŒ‰éœ€è°ƒæ•´ï¼‰
on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * *'

jobs:
  sync-tv:
    runs-on: ubuntu-latest
    timeout-minutes: 8  # ç¼©çŸ­è¶…æ—¶æ—¶é—´ï¼Œæå‡æ•ˆç‡
    defaults:
      run:
        shell: bash  # ç»Ÿä¸€Shellç¯å¢ƒï¼Œé¿å…å…¼å®¹æ€§é—®é¢˜
    steps:
      # æ­¥éª¤1ï¼šæ‹‰å–ç¬¬ä¸€ä»“åº“ï¼ˆä»…å½“ä¾èµ–ä»“åº“å†…è„šæœ¬æ—¶ä¿ç•™ï¼Œæ— ä¾èµ–å¯åˆ é™¤ï¼‰
      - name: Checkout First Repo
        uses: actions/checkout@v4
        with:
          repository: mr-pangpang/AutoBuild
          fetch-depth: 1
          quiet: true  # å‡å°‘å†—ä½™æ—¥å¿—

      # æ­¥éª¤2ï¼šä¸‹è½½TVæºï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼Œä¼˜åŒ–ç½‘ç»œå®¹é”™ï¼‰
      - name: Download TV.txt
        id: download
        run: |
          # 1. åˆ›å»ºä¸´æ—¶ç›®å½•ï¼ˆåŠ æƒé™é˜²æƒé™é—®é¢˜ï¼‰
          mkdir -p ./temp && chmod 755 ./temp
          # 2. å¢å¼ºä¸‹è½½é…ç½®ï¼š5æ¬¡é‡è¯•ã€10ç§’è¶…æ—¶ã€æ˜¾ç¤ºè¿›åº¦
          curl -sSL --retry 5 --retry-delay 2 --connect-timeout 10 \
            -o ./temp/tv.txt "http://123.56.43.183/tv/TV.txt"
          # 3. åŒé‡æ ¡éªŒæ–‡ä»¶æœ‰æ•ˆæ€§
          if [ ! -f ./temp/tv.txt ] || [ $(stat -c %s ./temp/tv.txt) -lt 100 ]; then
            echo "::error title=Download Failed::TV.txt is missing or too small (invalid)"
            exit 1
          fi
          # 4. è¾“å‡ºæ–‡ä»¶ä¿¡æ¯åˆ°æ­¥éª¤å˜é‡ï¼Œæ–¹ä¾¿åç»­æŸ¥çœ‹
          echo "file_size=$(du -sh ./temp/tv.txt | awk '{print $1}')" >> $GITHUB_OUTPUT
          echo "âœ… Downloaded valid TV.txt (size: ${{ steps.download.outputs.file_size }})"

      # æ­¥éª¤3ï¼šæ¨é€è‡³ç¬¬äºŒä»“åº“ï¼ˆä¼˜åŒ–æˆæƒé€»è¾‘+åˆ†æ”¯é€‚é…ï¼‰
      - name: Push to Second Repo (dpdisk/file)
        env:
          TOKEN: ${{ secrets.PANGPANG }}
          REPO_URL: "github.com/dpdisk/file.git"  # ç®€åŒ–åœ°å€æ ¼å¼
          BRANCH: "main"  # åˆ†æ”¯å¯é…ç½®ï¼Œè‹¥ä¸ºmasteråˆ™ä¿®æ”¹æ­¤å¤„
        run: |
          # 1. é…ç½®Gitï¼ˆç²¾ç®€èº«ä»½ä¿¡æ¯ï¼‰
          git config --global user.name "Actions-Sync"
          git config --global user.email "actions@github.com"
          # 2. å…‹éš†ä»“åº“ï¼ˆç”¨ç²¾ç®€åœ°å€ï¼Œé¿å…é‡å¤æ‹¼æ¥ï¼‰
          git clone "https://$TOKEN@$REPO_URL" ./second-repo --quiet
          [ $? -ne 0 ] && { echo "::error title=Clone Failed::Repository not found or token invalid"; exit 1; }
          
          # 3. æ›¿æ¢æ–‡ä»¶ï¼ˆåŠ å®‰å…¨æ ¡éªŒï¼‰
          cd ./second-repo
          rm -f tv.txt  # å¼ºåˆ¶åˆ é™¤æ—§æ–‡ä»¶ï¼ˆé˜²æ®‹ç•™ï¼‰
          cp ../temp/tv.txt ./tv.txt
          [ ! -f tv.txt ] && { echo "::error title=Copy Failed::tv.txt missing after copy"; exit 1; }
          
          # 4. æäº¤æ¨é€ï¼ˆé¿å…ç©ºæäº¤+ç²¾ç®€æ—¥å¿—ï¼‰
          git add tv.txt
          git diff --cached --quiet && { echo "â„¹ï¸ No changes to tv.txt, skip push"; exit 0; }
          git commit -m "Auto-sync TV source ($(date +'%Y-%m-%d'))" --quiet
          git push origin $BRANCH --quiet
          
          # 5. æ¨é€ç»“æœæ ¡éªŒ
          [ $? -eq 0 ] && echo "âœ… Pushed to $REPO_URL (branch: $BRANCH)" || { echo "::error title=Push Failed::Permission denied or branch error"; exit 1; }

      # æ­¥éª¤4ï¼šæ¸…ç†ï¼ˆä¼˜åŒ–æ‰§è¡Œæ—¶æœºï¼Œä»…æˆåŠŸæ—¶æ¸…ç†ï¼Œå¤±è´¥ä¿ç•™æ–‡ä»¶ä¾¿äºæ’æŸ¥ï¼‰
      - name: Clean Temporary Files
        if: success()  # ä»…æˆåŠŸæ—¶æ¸…ç†ï¼Œå¤±è´¥æ—¶ä¿ç•™æ–‡ä»¶ä¾›æ—¥å¿—æ’æŸ¥
        run: |
          rm -rf ./temp ./second-repo
          echo "ğŸ§¹ Cleaned temporary files"

      # æ­¥éª¤5ï¼šè¾“å‡ºæ€»ç»“ï¼ˆæå‡å¯è¯»æ€§ï¼Œä¸€çœ¼çœ‹ç»“æœï¼‰
      - name: Sync Summary
        if: always()
        run: |
          echo "==================== Sync Result ===================="
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… All steps completed: TV.txt (size: ${{ steps.download.outputs.file_size }}) synced to second repo"
          else
            echo "âŒ Sync failed: Check previous steps for errors (e.g., download/clone/push)"
          fi
          echo "======================================================"
