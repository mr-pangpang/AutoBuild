name: Clear Workflow Runs
on:
  workflow_dispatch:    # 手动触发
    inputs:
      retain_days:
        description: '保留最近多少天的运行记录？'
        required: true
        default: '30'
        type: number
      workflow_name:
        description: '要清理的工作流文件名（例如 ci.yml）'
        required: true
        type: string
  schedule:
    # 每天 UTC 时间 00:00 运行一次（北京时间 08:00）
    - cron: '0 0 * * *'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y

      - name: Delete old workflow runs
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}  # 使用你的 PAT_TOKEN
          RETAIN_DAYS: ${{ github.event.inputs.retain_days || 30 }}
          TARGET_WORKFLOW: ${{ github.event.inputs.workflow_name || 'your-default-workflow.yml' }}
        run: |
          # 计算截止日期
          cutoff_date=$(date -u -d "$RETAIN_DAYS days ago" +"%Y-%m-%d")
          echo "🗑️  Deleting runs from workflow '$TARGET_WORKFLOW' older than $cutoff_date"

          # 获取符合条件的运行ID列表
          echo "📋 Fetching run IDs to delete..."
          run_ids=$(gh run list -R "${{ github.repository }}" -w "$TARGET_WORKFLOW" --json databaseId,createdAt,status -q ".[] | select(.createdAt < \"$cutoff_date\") | .databaseId" | head -n 50)

          if [ -z "$run_ids" ]; then
            echo "✅ No old runs found to delete."
            exit 0
          fi

          # 循环删除每一个运行记录
          count=0
          for id in $run_ids; do
            echo "🧹 Deleting run ID: $id"
            gh run delete "$id" -R "${{ github.repository }}" --confirm
            count=$((count + 1))
            # 稍微延迟一下，避免触发API速率限制
            sleep 0.5
          done

          echo "🎉 Cleanup completed! Deleted $count run(s)."
