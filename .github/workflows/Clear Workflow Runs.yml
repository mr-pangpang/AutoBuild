name: Clear Workflow Runs
on:
  workflow_dispatch:    # æ‰‹åŠ¨è§¦å‘
    inputs:
      retain_days:
        description: 'ä¿ç•™æœ€è¿‘å¤šå°‘å¤©çš„è¿è¡Œè®°å½•ï¼Ÿ'
        required: true
        default: '30'
        type: number
      workflow_name:
        description: 'è¦æ¸…ç†çš„å·¥ä½œæµæ–‡ä»¶åï¼ˆä¾‹å¦‚ ci.ymlï¼‰'
        required: true
        type: string
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 00:00 è¿è¡Œä¸€æ¬¡ï¼ˆåŒ—äº¬æ—¶é—´ 08:00ï¼‰
    - cron: '0 0 * * *'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        run: |
          type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
          curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
          && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
          && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
          && sudo apt update \
          && sudo apt install gh -y

      - name: Delete old workflow runs
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}  # ä½¿ç”¨ä½ çš„ PAT_TOKEN
          RETAIN_DAYS: ${{ github.event.inputs.retain_days || 30 }}
          TARGET_WORKFLOW: ${{ github.event.inputs.workflow_name || 'your-default-workflow.yml' }}
        run: |
          # è®¡ç®—æˆªæ­¢æ—¥æœŸ
          cutoff_date=$(date -u -d "$RETAIN_DAYS days ago" +"%Y-%m-%d")
          echo "ğŸ—‘ï¸  Deleting runs from workflow '$TARGET_WORKFLOW' older than $cutoff_date"

          # è·å–ç¬¦åˆæ¡ä»¶çš„è¿è¡ŒIDåˆ—è¡¨
          echo "ğŸ“‹ Fetching run IDs to delete..."
          run_ids=$(gh run list -R "${{ github.repository }}" -w "$TARGET_WORKFLOW" --json databaseId,createdAt,status -q ".[] | select(.createdAt < \"$cutoff_date\") | .databaseId" | head -n 50)

          if [ -z "$run_ids" ]; then
            echo "âœ… No old runs found to delete."
            exit 0
          fi

          # å¾ªç¯åˆ é™¤æ¯ä¸€ä¸ªè¿è¡Œè®°å½•
          count=0
          for id in $run_ids; do
            echo "ğŸ§¹ Deleting run ID: $id"
            gh run delete "$id" -R "${{ github.repository }}" --confirm
            count=$((count + 1))
            # ç¨å¾®å»¶è¿Ÿä¸€ä¸‹ï¼Œé¿å…è§¦å‘APIé€Ÿç‡é™åˆ¶
            sleep 0.5
          done

          echo "ğŸ‰ Cleanup completed! Deleted $count run(s)."
