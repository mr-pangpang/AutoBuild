name: Gather Auto-Build

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCå‡Œæ™¨æ‰§è¡Œ
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  save-gather:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è°ƒè¯•ç½‘ç»œè¿æ¥
        run: |
          echo "ğŸ” å¼€å§‹ç½‘ç»œè¯Šæ–­..."
          
          # æµ‹è¯•åŸŸåè§£æ
          echo "1. è§£æåŸŸå tv-1.iill.top"
          nslookup tv-1.iill.top || echo "âš ï¸  DNSè§£æå¯èƒ½æœ‰é—®é¢˜"
          
          # æµ‹è¯•ç½‘ç»œè¿é€šæ€§
          echo "2. æµ‹è¯•ç½‘ç»œè¿é€šæ€§"
          ping -c 3 tv-1.iill.top || echo "âš ï¸  ç½‘ç»œè¿é€šæ€§æµ‹è¯•å¤±è´¥"
          
          # æµ‹è¯•HTTPè®¿é—®
          echo "3. æµ‹è¯•HTTPè®¿é—®"
          curl -I "https://tv-1.iill.top/m3u/Gather" --connect-timeout 10 || echo "âš ï¸  HTTPè®¿é—®æµ‹è¯•å¤±è´¥"

      - name: å°è¯•å¤šç§æ–¹å¼ä¸‹è½½
        id: download
        run: |
          echo "ğŸ”„ å°è¯•å¤šç§ä¸‹è½½æ–¹å¼..."
          
          # æ–¹æ³•1: æ ‡å‡†curl
          echo "æ–¹æ³•1: æ ‡å‡†curlä¸‹è½½"
          if curl -sSf --retry 2 --connect-timeout 15 --max-time 30 \
             -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
             -H "Accept: text/plain, */*" \
             -H "Referer: https://tv-1.iill.top/" \
             "https://tv-1.iill.top/m3u/Gather" -o "Gather.txt" && [ -s "Gather.txt" ]; then
            echo "âœ… æ–¹æ³•1æˆåŠŸ"
            exit 0
          fi
          
          # æ–¹æ³•2: ä½¿ç”¨wget
          echo "æ–¹æ³•2: ä½¿ç”¨wget"
          if wget --timeout=20 --tries=2 -U "Mozilla/5.0" \
             "https://tv-1.iill.top/m3u/Gather" -O "Gather.txt" && [ -s "Gather.txt" ]; then
            echo "âœ… æ–¹æ³•2æˆåŠŸ"
            exit 0
          fi
          
          # æ–¹æ³•3: å°è¯•HTTPåè®®
          echo "æ–¹æ³•3: å°è¯•HTTPåè®®"
          if curl -sSf --retry 2 --connect-timeout 15 --max-time 30 \
             "http://tv-1.iill.top/m3u/Gather" -o "Gather.txt" && [ -s "Gather.txt" ]; then
            echo "âœ… æ–¹æ³•3æˆåŠŸ"
            exit 0
          fi
          
          # æ‰€æœ‰æ–¹æ³•éƒ½å¤±è´¥
          echo "âŒ æ‰€æœ‰ä¸‹è½½æ–¹æ³•éƒ½å¤±è´¥"
          echo "æ­£åœ¨åˆ›å»ºç©ºæ–‡ä»¶ç”¨äºæµ‹è¯•..."
          echo "# æ— æ³•è·å–å†…å®¹ - $(date)" > "Gather.txt"
          echo "created_empty=true" >> $GITHUB_OUTPUT
          exit 1

      - name: åˆ†æä¸‹è½½å†…å®¹
        run: |
          echo "ğŸ“Š æ–‡ä»¶åˆ†æ:"
          if [ -f "Gather.txt" ]; then
            echo "æ–‡ä»¶å¤§å°: $(wc -c < Gather.txt) å­—èŠ‚"
            echo "æ–‡ä»¶ç±»å‹: $(file -b Gather.txt || echo 'æœªçŸ¥')"
            echo "å‰100å­—èŠ‚:"
            head -c 100 Gather.txt | cat -A
            echo ""
            echo "å‰5è¡Œ:"
            head -n 5 Gather.txt || echo "æ— æ³•è¯»å–è¡Œ"
          else
            echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi

      - name: æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆå†…å®¹
        id: validate
        run: |
          if [ ! -f "Gather.txt" ]; then
            echo "is_valid=false" >> $GITHUB_OUTPUT
            echo "reason=file_not_exists" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          content=$(head -c 500 "Gather.txt" || echo "")
          
          # æ£€æŸ¥å¸¸è§é”™è¯¯é¡µé¢ç‰¹å¾
          if echo "$content" | grep -qi "error\|404\|not.found\|access.denied\|cloudflare"; then
            echo "is_valid=false" >> $GITHUB_OUTPUT
            echo "reason=error_page" >> $GITHUB_OUTPUT
          elif echo "$content" | grep -qi "<html\|<!DOCTYPE"; then
            echo "is_valid=false" >> $GITHUB_OUTPUT
            echo "reason=html_page" >> $GITHUB_OUTPUT
          elif [ $(wc -c < "Gather.txt") -lt 10 ]; then
            echo "is_valid=false" >> $GITHUB_OUTPUT
            echo "reason=too_small" >> $GITHUB_OUTPUT
          else
            echo "is_valid=true" >> $GITHUB_OUTPUT
          fi

      - name: å¤„ç†æ— æ•ˆå†…å®¹
        if: steps.validate.outputs.is_valid == 'false'
        run: |
          echo "âš ï¸  å†…å®¹æ— æ•ˆ: ${{ steps.validate.outputs.reason }}"
          echo "å½“å‰å†…å®¹:"
          head -n 3 "Gather.txt" || echo "æ— å†…å®¹"
          
          # ä¿å­˜é”™è¯¯ä¿¡æ¯
          echo "# è·å–å¤±è´¥ - ${{ steps.validate.outputs.reason }}" > "Gather.txt"
          echo "# æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S CST')" >> "Gather.txt"
          echo "# æ¥æº: https://tv-1.iill.top/m3u/Gather" >> "Gather.txt"

      - name: æäº¤æ–‡ä»¶
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@users.noreply.github.com"
          
          git add Gather.txt
          
          if [ "${{ steps.validate.outputs.is_valid }}" = "true" ]; then
            line_count=$(wc -l < "Gather.txt")
            file_size=$(du -h "Gather.txt" | cut -f1)
            commit_msg="âœ… æ›´æ–°Gatheråˆ—è¡¨ - $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M CST') | è¡Œæ•°: $line_count"
          else
            commit_msg="âš ï¸  è·å–å¤±è´¥ - ${{ steps.validate.outputs.reason }} - $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M CST')"
          fi
          
          git commit -m "$commit_msg" || exit 0
          git push origin ${{ github.ref }}
          
          echo "ğŸ“¤ æäº¤å®Œæˆ: $commit_msg"

      - name: å®Œæˆæ€»ç»“
        run: |
          echo "ğŸ‰ æµç¨‹å®Œæˆ"
          echo "æœ‰æ•ˆæ€§: ${{ steps.validate.outputs.is_valid }}"
          echo "åŸå› : ${{ steps.validate.outputs.reason || 'N/A' }}"
          echo "æ–‡ä»¶ä¿¡æ¯:"
          ls -la Gather.txt
