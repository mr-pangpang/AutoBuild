name: Update TVBOX Source with PowerShell

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  update:
    runs-on: windows-latest
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download with curl (PowerShell)
      shell: pwsh
      run: |
        Write-Host "ğŸš€ å¼€å§‹ä¸‹è½½ç›´æ’­æº..."
        
        # ä½¿ç”¨curlå‘½ä»¤ï¼ˆä¸æœ¬åœ°batä¸€è‡´ï¼‰
        curl -s -L "https://tv-1.iill.top/m3u/Gather" -o Gather.txt
        
        if (Test-Path "Gather.txt" -And (Get-Item "Gather.txt").Length -gt 0) {
            $lineCount = (Get-Content "Gather.txt" | Measure-Object -Line).Lines
            Write-Host "âœ… ä¸‹è½½æˆåŠŸï¼æ–‡ä»¶å…± $lineCount è¡Œ"
            
            # æ˜¾ç¤ºæ–‡ä»¶å¼€å¤´å†…å®¹
            $firstLines = Get-Content "Gather.txt" -First 3
            Write-Host "æ–‡ä»¶å¼€å¤´å†…å®¹ï¼š"
            $firstLines | ForEach-Object { Write-Host "  $_" }
        } else {
            Write-Host "âŒ ä¸‹è½½å¤±è´¥ï¼Œåˆ›å»ºç©ºæ–‡ä»¶"
            Set-Content -Path "Gather.txt" -Value "#EXTM3U`n# ä¸‹è½½å¤±è´¥æ—¶é—´: $(Get-Date)"
        }

    - name: Commit changes
      shell: pwsh
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        git add Gather.txt
        $hasChanges = git status --porcelain
        if ($hasChanges) {
            git commit -m "ğŸ“º è‡ªåŠ¨æ›´æ–°TVBOXç›´æ’­æº $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
            git push
            Write-Host "âœ… æ›´æ–°å®Œæˆï¼"
        } else {
            Write-Host "ğŸŸ¡ å†…å®¹æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        }
