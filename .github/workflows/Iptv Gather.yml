name: Update Gather Content Windows

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  update-gather:
    runs-on: windows-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Fetch content using PowerShell
      shell: pwsh
      run: |
        try {
          # 下载内容
          $response = Invoke-WebRequest -Uri "https://tv-1.iill.top/m3u/Gather" -UseBasicParsing
          $content = $response.Content
          
          # 保存到文件
          Set-Content -Path "Gather.txt" -Value $content -Encoding UTF8
          
          # 配置 git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # 检查是否有变化并提交
          git add Gather.txt
          $hasChanges = git status --porcelain
          if ($hasChanges) {
            git commit -m "Auto-update Gather.txt $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
            git push
            Write-Output "Gather.txt updated successfully"
          } else {
            Write-Output "No changes detected"
          }
        }
        catch {
          Write-Error "Failed to fetch content: $($_.Exception.Message)"
          exit 1
        }
