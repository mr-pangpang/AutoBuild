name: Update TVBOX Gather Source

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 2 * * *' # æ¯å¤©UTCæ—¶é—´02:00ï¼ˆåŒ—äº¬æ—¶é—´10:00ï¼‰è¿è¡Œ

jobs:
  update-tvbox-source:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup curl with retry
      run: |
        # å®‰è£…æœ€æ–°ç‰ˆcurlï¼ˆç¡®ä¿æ”¯æŒé‡è¯•ï¼‰
        sudo apt-get update
        sudo apt-get install -y curl

    - name: Fetch TVBOX source content
      run: |
        echo "ğŸ“¡ å¼€å§‹è·å–TVBOXç›´æ’­æº..."
        
        # è®¾ç½®é‡è¯•æœºåˆ¶
        max_retries=5
        retry_count=0
        
        while [ $retry_count -lt $max_retries ]; do
          echo "å°è¯•ç¬¬ $((retry_count + 1)) æ¬¡è·å–..."
          
          # ä½¿ç”¨curlè·å–å†…å®¹ï¼Œæ·»åŠ TVBOXç›¸å…³çš„User-Agent
          curl -s -L --connect-timeout 30 --max-time 60 \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
            -H "Accept: */*" \
            -H "Accept-Language: zh-CN,zh;q=0.9,en;q=0.8" \
            -H "Connection: keep-alive" \
            -H "Referer: https://tv-1.iill.top/" \
            "https://tv-1.iill.top/m3u/Gather" \
            -o Gather.txt
          
          # æ£€æŸ¥æ˜¯å¦è·å–æˆåŠŸ
          if [ -s "Gather.txt" ]; then
            line_count=$(wc -l < Gather.txt)
            echo "âœ… è·å–æˆåŠŸï¼æ–‡ä»¶åŒ…å« $line_count è¡Œ"
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„M3Uæ–‡ä»¶
            if head -n 5 Gather.txt | grep -q "#EXTM3U"; then
              echo "ğŸ¯ éªŒè¯é€šè¿‡ï¼šæ˜¯æœ‰æ•ˆçš„M3Uæ–‡ä»¶"
              break
            else
              echo "âš ï¸  æ–‡ä»¶æ ¼å¼å¯èƒ½ä¸æ˜¯æ ‡å‡†M3Uï¼Œä½†å†…å®¹ä¸ä¸ºç©º"
              # æ˜¾ç¤ºæ–‡ä»¶å¼€å¤´å†…å®¹
              echo "æ–‡ä»¶å¼€å¤´å†…å®¹ï¼š"
              head -n 3 Gather.txt
              break
            fi
          else
            retry_count=$((retry_count + 1))
            echo "âŒ ç¬¬ $retry_count æ¬¡è·å–å¤±è´¥ï¼Œç­‰å¾…é‡è¯•..."
            sleep 10
          fi
        done
        
        # æœ€ç»ˆæ£€æŸ¥
        if [ ! -s "Gather.txt" ]; then
          echo "âŒ æ‰€æœ‰é‡è¯•éƒ½å¤±è´¥ï¼Œåˆ›å»ºé”™è¯¯æç¤ºæ–‡ä»¶"
          cat > Gather.txt << 'EOF'
#EXTM3U
#EXTINF:-1 tvg-id="" tvg-name="é”™è¯¯æç¤º" tvg-logo="" group-title="Error",è·å–ç›´æ’­æºå¤±è´¥
https://example.com/error.m3u8

# æ›´æ–°æ—¶é—´: $(date +"%Y-%m-%d %H:%M:%S")
# é”™è¯¯ä¿¡æ¯: æ— æ³•ä» https://tv-1.iill.top/m3u/Gather è·å–å†…å®¹
# è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æºåœ°å€æ˜¯å¦æœ‰æ•ˆ
EOF
        fi

    - name: Validate and format M3U file
      run: |
        echo "ğŸ” éªŒè¯æ–‡ä»¶æ ¼å¼..."
        
        # ç¡®ä¿æ–‡ä»¶ä»¥UTF-8ç¼–ç ä¿å­˜
        if [ -s "Gather.txt" ]; then
          # æ£€æŸ¥æ–‡ä»¶ç¼–ç å¹¶è½¬æ¢ä¸ºUTF-8ï¼ˆå¦‚æœéœ€è¦ï¼‰
          file_encoding=$(file -b --mime-encoding Gather.txt)
          echo "æ–‡ä»¶ç¼–ç : $file_encoding"
          
          if [ "$file_encoding" != "utf-8" ] && [ "$file_encoding" != "us-ascii" ]; then
            echo "è½¬æ¢ç¼–ç åˆ°UTF-8..."
            iconv -f "$file_encoding" -t utf-8 Gather.txt > Gather_utf8.txt
            mv Gather_utf8.txt Gather.txt
          fi
          
          # æ·»åŠ æ–‡ä»¶å¤´ä¿¡æ¯ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          if ! grep -q "^#EXTM3U" Gather.txt; then
            echo "æ·»åŠ M3Uæ–‡ä»¶å¤´..."
            echo "#EXTM3U" | cat - Gather.txt > temp.txt
            mv temp.txt Gather.txt
          fi
          
          # æ·»åŠ æ›´æ–°æ—¶é—´æ³¨é‡Š
          echo "# æœ€åæ›´æ–°æ—¶é—´: $(date +"%Y-%m-%d %H:%M:%S")" >> Gather.txt
          echo "# æ›´æ–°æ–¹å¼: GitHub Actionsè‡ªåŠ¨æ›´æ–°" >> Gather.txt
          echo "# æºåœ°å€: https://tv-1.iill.top/m3u/Gather" >> Gather.txt
        fi

    - name: Display file info
      run: |
        echo "ğŸ“Š æ–‡ä»¶ä¿¡æ¯ï¼š"
        echo "æ–‡ä»¶å¤§å°: $(wc -c < Gather.txt) å­—èŠ‚"
        echo "æ–‡ä»¶è¡Œæ•°: $(wc -l < Gather.txt) è¡Œ"
        echo "æ–‡ä»¶ç±»å‹: $(file -b Gather.txt)"
        echo "å‰5è¡Œå†…å®¹ï¼š"
        head -n 5 Gather.txt
        echo "å3è¡Œå†…å®¹ï¼š"
        tail -n 3 Gather.txt

    - name: Commit and push changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
        if git diff --quiet Gather.txt; then
          echo "ğŸŸ¢ å†…å®¹æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
        else
          echo "ğŸ”„ æ£€æµ‹åˆ°å˜åŒ–ï¼Œå‡†å¤‡æäº¤..."
          git add Gather.txt
          git commit -m "ğŸ“º è‡ªåŠ¨æ›´æ–°TVBOXç›´æ’­æº $(date +'%Y-%m-%d %H:%M:%S')"
          git push
          echo "âœ… ç›´æ’­æºå·²æ›´æ–°å¹¶æ¨é€åˆ°ä»“åº“"
        fi

    - name: Create summary
      if: always()
      run: |
        echo "## TVBOXç›´æ’­æºæ›´æ–°ç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æ›´æ–°æ—¶é—´**: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -s "Gather.txt" ]; then
          line_count=$(wc -l < Gather.txt)
          echo "**æ–‡ä»¶çŠ¶æ€**: âœ… è·å–æˆåŠŸ ($line_count è¡Œ)" >> $GITHUB_STEP_SUMMARY
          echo "**æ–‡ä»¶é¢„è§ˆ**: \`$(head -n 2 Gather.txt | tr '\n' ' ')\`" >> $GITHUB_STEP_SUMMARY
        else
          echo "**æ–‡ä»¶çŠ¶æ€**: âŒ è·å–å¤±è´¥" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**æºåœ°å€**: https://tv-1.iill.top/m3u/Gather" >> $GITHUB_STEP_SUMMARY
