name: Fetch TV Content

on:
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCæ—¶é—´00:00è‡ªåŠ¨è¿è¡Œ
  push:
    paths:
      - '.github/workflows/fetch-tv-content.yml'  # å½“å·¥ä½œæµæ–‡ä»¶æ›´æ”¹æ—¶è§¦å‘

jobs:
  fetch-and-commit:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Create directories if not exist
      run: |
        mkdir -p disk/TV

    - name: Fetch Gather.txt content
      run: |
        echo "æ­£åœ¨ä» http://123.56.43.183/tv/Gather.txt ä¸‹è½½æ–‡ä»¶..."
        if curl -s -f http://123.56.43.183/tv/Gather.txt -o disk/TV/Gather.txt; then
          echo "ä¸‹è½½æˆåŠŸ"
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
          if [ -s disk/TV/Gather.txt ]; then
            echo "æ–‡ä»¶å†…å®¹æœ‰æ•ˆ"
          else
            echo "è­¦å‘Šï¼šä¸‹è½½çš„æ–‡ä»¶ä¸ºç©º"
            exit 1
          fi
        else
          echo "é”™è¯¯ï¼šä¸‹è½½å¤±è´¥"
          exit 1
        fi

    - name: Check for changes
      id: check_changes
      run: |
        if git diff --quiet; then
          echo "changes_detected=false" >> $GITHUB_OUTPUT
          echo "æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹"
        else
          echo "changes_detected=true" >> $GITHUB_OUTPUT
          echo "æ£€æµ‹åˆ°æ–‡ä»¶æ›´æ”¹"
          git diff --name-only
        fi

    - name: Commit and push changes
      if: steps.check_changes.outputs.changes_detected == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add disk/TV/Gather.txt
        git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–° Gather.txt - $(date +'%Y-%m-%d %H:%M:%S')"
        git push
        echo "æ›´æ”¹å·²æäº¤å¹¶æ¨é€"

    - name: No changes detected
      if: steps.check_changes.outputs.changes_detected == 'false'
      run: |
        echo "æ²¡æœ‰æ£€æµ‹åˆ°æ›´æ”¹ï¼Œè·³è¿‡æäº¤"
