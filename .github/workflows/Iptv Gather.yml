name: Gather Debug

on:
  workflow_dispatch:  # ä»…æ‰‹åŠ¨è§¦å‘

jobs:
  debug-gather:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€æŸ¥ç³»ç»Ÿç¯å¢ƒ
        run: |
          echo "ğŸ–¥ï¸  ç³»ç»Ÿä¿¡æ¯:"
          echo "Runner: $RUNNER_OS"
          echo "å½“å‰æ—¶é—´: $(date)"
          echo "IPåœ°å€:"
          curl -s ifconfig.me
          echo ""

      - name: æµ‹è¯•ç½‘ç»œè¿é€šæ€§
        run: |
          echo "ğŸŒ ç½‘ç»œæµ‹è¯•:"
          echo "1. æµ‹è¯•åŸºç¡€ç½‘ç»œ:"
          ping -c 2 google.com || echo "åŸºç¡€ç½‘ç»œä¸é€š"
          
          echo "2. æµ‹è¯•ç›®æ ‡åŸŸåè§£æ:"
          nslookup tv-1.iill.top || dig tv-1.iill.top || echo "DNSè§£æå¤±è´¥"
          
          echo "3. æµ‹è¯•ç›®æ ‡æœåŠ¡å™¨è¿é€šæ€§:"
          ping -c 2 tv-1.iill.top || echo "Pingç›®æ ‡å¤±è´¥"
          
          echo "4. æµ‹è¯•ç«¯å£è¿é€šæ€§:"
          timeout 5 bash -c "echo >/dev/tcp/tv-1.iill.top/443" && echo "ç«¯å£443å¼€æ”¾" || echo "ç«¯å£443ä¸å¯è¾¾"

      - name: è¯¦ç»†HTTPæµ‹è¯•
        run: |
          echo "ğŸ” HTTPè¯¦ç»†æµ‹è¯•:"
          echo "1. è·å–HTTPå¤´ä¿¡æ¯:"
          curl -I -v --connect-timeout 10 --max-time 15 \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            "https://tv-1.iill.top/m3u/Gather" 2>&1 | head -20 || echo "è·å–å¤´ä¿¡æ¯å¤±è´¥"
          
          echo "2. å°è¯•ä¸åŒUser-Agent:"
          for ua in \
            "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            "curl/7.68.0" \
            "Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X) AppleWebKit/605.1.15" \
            "Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)"
          do
            echo "å°è¯•UA: $ua"
            response=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 5 \
              -A "$ua" \
              "https://tv-1.iill.top/m3u/Gather")
            echo "çŠ¶æ€ç : $response"
          done

      - name: å°è¯•ç›´æ¥è®¿é—®
        run: |
          echo "ğŸš€ å°è¯•ç›´æ¥è®¿é—®å†…å®¹:"
          echo "æ–¹æ³•1: ç®€å•curl"
          curl -s --connect-timeout 10 "https://tv-1.iill.top/m3u/Gather" | head -c 200 | cat -A
          echo ""
          
          echo "æ–¹æ³•2: è¯¦ç»†è¾“å‡º"
          curl -v --connect-timeout 10 "https://tv-1.iill.top/m3u/Gather" 2>&1 | grep -E "(HTTP/|<|>)" | head -10
          
          echo "æ–¹æ³•3: ä¿å­˜åˆ°æ–‡ä»¶æ£€æŸ¥"
          timeout 15 curl -s "https://tv-1.iill.top/m3u/Gather" -o debug_output.txt
          if [ -f debug_output.txt ]; then
            echo "æ–‡ä»¶å¤§å°: $(wc -c < debug_output.txt) bytes"
            echo "æ–‡ä»¶ç±»å‹: $(file -b debug_output.txt)"
            echo "å‰50å­—ç¬¦:"
            head -c 50 debug_output.txt | cat -A
            echo ""
          fi

      - name: æµ‹è¯•æ›¿ä»£æ–¹æ¡ˆ
        run: |
          echo "ğŸ”„ æµ‹è¯•æ›¿ä»£URL:"
          # å°è¯•å¯èƒ½çš„æ›¿ä»£URLæ ¼å¼
          urls=(
            "https://tv-1.iill.top/m3u/Gather"
            "http://tv-1.iill.top/m3u/Gather"
            "https://tv-1.iill.top/Gather"
            "https://tv-1.iill.top/m3u/gather"
          )
          
          for url in "${urls[@]}"; do
            echo "æµ‹è¯•: $url"
            code=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 5 "$url")
            echo "çŠ¶æ€ç : $code"
            if [ "$code" = "200" ]; then
              echo "âœ… å¯èƒ½æœ‰æ•ˆçš„URL: $url"
              curl -s "$url" | head -2
            fi
            echo "---"
          done

      - name: ç”Ÿæˆæµ‹è¯•æ–‡ä»¶
        run: |
          echo "ğŸ“ ç”Ÿæˆæµ‹è¯•æ–‡ä»¶:"
          cat > Gather.txt << EOF
#EXTM3U
# è°ƒè¯•ä¿¡æ¯ - æ— æ³•ä»æºç«™è·å–å†…å®¹
# æ—¶é—´: $(date)
# æºç«™: https://tv-1.iill.top/m3u/Gather
# çŠ¶æ€: è¿æ¥æµ‹è¯•å¤±è´¥
# è¯·æŸ¥çœ‹å·¥ä½œæµç¨‹æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯

# ç¤ºä¾‹é¢‘é“ï¼ˆæµ‹è¯•ç”¨ï¼‰
#EXTINF:-1 tvg-id="test1" tvg-name="æµ‹è¯•é¢‘é“1" tvg-logo="https://example.com/logo.png" group-title="æµ‹è¯•",æµ‹è¯•é¢‘é“1
http://example.com/stream1
EOF
          
          echo "æµ‹è¯•æ–‡ä»¶å·²åˆ›å»º"
          ls -la Gather.txt
          echo "å‰5è¡Œ:"
          head -5 Gather.txt

      - name: æ˜¾ç¤ºå®Œæ•´è¯Šæ–­æŠ¥å‘Š
        run: |
          echo "ğŸ“Š è¯Šæ–­æŠ¥å‘Šå®Œæˆ"
          echo "=========================================="
          echo "å¦‚æœæ‰€æœ‰æµ‹è¯•éƒ½å¤±è´¥ï¼Œå¯èƒ½çš„åŸå› :"
          echo "1. ğŸ”’ ç½‘ç«™éœ€è¦ç‰¹å®šè®¤è¯æˆ–Token"
          echo "2. ğŸŒ GitHub Actionsçš„IPè¢«å°é”"
          echo "3. ğŸš« URLå·²å¤±æ•ˆæˆ–å˜æ›´"
          echo "4. â° ç½‘ç«™ä¸´æ—¶ä¸å¯ç”¨"
          echo "5. ğŸ›¡ï¸  Cloudflare/WAFé˜²æŠ¤"
          echo ""
          echo "å»ºè®®è§£å†³æ–¹æ¡ˆ:"
          echo "1. æ‰‹åŠ¨è®¿é—®URLç¡®è®¤æ˜¯å¦å¯ç”¨"
          echo "2. æ£€æŸ¥æ˜¯å¦éœ€è¦APIå¯†é’¥"
          echo "3. è”ç³»ç½‘ç«™ç®¡ç†å‘˜"
          echo "4. ä½¿ç”¨ä»£ç†æœåŠ¡å™¨"
          echo "=========================================="
