name: Gather Auto-Build

on:
  schedule:
    - cron: '0 0 * * *'  # æ¯å¤©UTCå‡Œæ™¨æ‰§è¡Œ
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  save-gather:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # æˆäºˆå†™å…¥æƒé™
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # æ‹‰å–å®Œæ•´å†å²

      - name: ä¸‹è½½Gatheræ–‡ä»¶
        run: |
          echo "å¼€å§‹ä¸‹è½½Gatheræ–‡ä»¶: https://tv-1.iill.top/m3u/Gather"
          
          # ä¸‹è½½æ–‡ä»¶
          curl -sSf --retry 3 --max-time 60 \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            "https://tv-1.iill.top/m3u/Gather" -o "Gather.txt"
          
          # æ£€æŸ¥ä¸‹è½½ç»“æœ
          if [ ! -f "Gather.txt" ]; then
            echo "âŒ Gather.txtä¸‹è½½å¤±è´¥"
            exit 1
          fi
          
          echo "âœ… ä¸‹è½½å®Œæˆ"

      - name: éªŒè¯æ–‡ä»¶å†…å®¹
        run: |
          echo "éªŒè¯Gather.txtæ–‡ä»¶..."
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
          if [ ! -s "Gather.txt" ]; then
            echo "âŒ Gather.txtå†…å®¹ä¸ºç©º"
            exit 1
          fi
          
          # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
          file_size=$(du -h "Gather.txt" | cut -f1)
          line_count=$(wc -l < "Gather.txt")
          
          echo "ğŸ“Š æ–‡ä»¶å¤§å°: $file_size"
          echo "ğŸ“ˆ è¡Œæ•°: $line_count"
          echo "ğŸ” å‰2è¡Œé¢„è§ˆ:"
          head -n 2 "Gather.txt"
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºæœ‰æ•ˆçš„M3Uæ ¼å¼
          if ! head -n 1 "Gather.txt" | grep -q "^#EXTM3U"; then
            echo "âš ï¸  è­¦å‘Š: æ–‡ä»¶å¯èƒ½ä¸æ˜¯æ ‡å‡†çš„M3Uæ ¼å¼"
          else
            echo "âœ… æ£€æµ‹åˆ°æ ‡å‡†M3Uæ ¼å¼"
          fi

      - name: æ£€æŸ¥æ–‡ä»¶å˜æ›´
        id: check_changes
        run: |
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨äºgitä¸­
          if git ls-files --error-unmatch "Gather.txt" >/dev/null 2>&1; then
            # æ–‡ä»¶å·²å­˜åœ¨ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
            if git diff --quiet "Gather.txt"; then
              echo "ğŸŸ¢ Gather.txtå†…å®¹æ— å˜åŒ–"
              echo "has_changes=false" >> $GITHUB_OUTPUT
            else
              echo "ğŸ”µ Gather.txtå†…å®¹æœ‰æ›´æ–°"
              echo "has_changes=true" >> $GITHUB_OUTPUT
            fi
          else
            # æ–°æ–‡ä»¶
            echo "ğŸŸ¡ Gather.txtæ˜¯æ–°æ–‡ä»¶"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: æäº¤æ›´æ–°
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          # é…ç½®Git
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@users.noreply.github.com"
          
          # æ·»åŠ æ–‡ä»¶
          git add Gather.txt
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          commit_time=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M CST')
          line_count=$(wc -l < "Gather.txt")
          file_size=$(du -h "Gather.txt" | cut -f1)
          
          commit_msg="ğŸ“º æ›´æ–°Gatheråˆ—è¡¨ - $commit_time
          è¡Œæ•°: $line_count | å¤§å°: $file_size
          æ¥æº: https://tv-1.iill.top/m3u/Gather"
          
          # æäº¤
          git commit -m "$commit_msg"
          
          # æ¨é€
          git push origin ${{ github.ref }}
          
          echo "âœ… å·²æˆåŠŸæäº¤å¹¶æ¨é€æ›´æ–°"

      - name: æ— æ›´æ–°æç¤º
        if: steps.check_changes.outputs.has_changes == 'false'
        run: |
          echo "â„¹ï¸ Gather.txtå†…å®¹æ— å˜åŒ–ï¼Œæ— éœ€æ›´æ–°"
          echo "å½“å‰æ–‡ä»¶ä¿¡æ¯:"
          echo "å¤§å°: $(du -h Gather.txt | cut -f1)"
          echo "è¡Œæ•°: $(wc -l < Gather.txt)"

      - name: å®Œæˆé€šçŸ¥
        run: |
          echo "ğŸ‰ Gatherè‡ªæ„å»ºæµç¨‹å®Œæˆ"
          echo "åˆ†æ”¯: ${{ github.ref }}"
          echo "è¿è¡Œæ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S CST')"
