name: Update TVBOX Source

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©UTCæ—¶é—´02:00ï¼ˆåŒ—äº¬æ—¶é—´10:00ï¼‰

jobs:
  update-source:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download TVBOX source
      run: |
        echo "å¼€å§‹ä¸‹è½½ç›´æ’­æº..."
        # ä½¿ç”¨wgetå°è¯•ä¸‹è½½
        wget --timeout=30 --tries=3 -O Gather.txt "https://tv-1.iill.top/m3u/Gather" || true
        
        # å¦‚æœwgetå¤±è´¥ï¼Œä½¿ç”¨curlå†è¯•ä¸€æ¬¡
        if [ ! -s Gather.txt ]; then
          echo "wgetå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨curl..."
          curl -s -L --max-time 30 -o Gather.txt "https://tv-1.iill.top/m3u/Gather" || true
        fi

        # æ£€æŸ¥æ˜¯å¦ä¸‹è½½æˆåŠŸ
        if [ -s Gather.txt ]; then
          echo "âœ… ä¸‹è½½æˆåŠŸï¼"
          echo "æ–‡ä»¶è¡Œæ•°: $(wc -l < Gather.txt)"
          echo "æ–‡ä»¶å¤§å°: $(wc -c < Gather.txt) å­—èŠ‚"
        else
          echo "âŒ ä¸‹è½½å¤±è´¥ï¼Œåˆ›å»ºç©ºæ–‡ä»¶"
          echo "#EXTM3U" > Gather.txt
          echo "# ä¸‹è½½å¤±è´¥äº $(date)" >> Gather.txt
        fi

    - name: Setup Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Commit and push
      run: |
        git add Gather.txt
        if ! git diff --staged --quiet; then
          git commit -m "Update TVBOX source - $(date +'%Y-%m-%d %H:%M')"
          git push
          echo "âœ… æ›´æ–°å·²æ¨é€"
        else
          echo "ğŸŸ¡ æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        fi
