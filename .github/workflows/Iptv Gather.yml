name: Update TVBOX Source

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'  # 每天UTC时间02:00（北京时间10:00）

jobs:
  update-source:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download TVBOX source
      run: |
        echo "开始下载直播源..."
        # 使用wget尝试下载
        wget --timeout=30 --tries=3 -O Gather.txt "https://tv-1.iill.top/m3u/Gather" || true
        
        # 如果wget失败，使用curl再试一次
        if [ ! -s Gather.txt ]; then
          echo "wget失败，尝试使用curl..."
          curl -s -L --max-time 30 -o Gather.txt "https://tv-1.iill.top/m3u/Gather" || true
        fi

        # 检查是否下载成功
        if [ -s Gather.txt ]; then
          echo "✅ 下载成功！"
          echo "文件行数: $(wc -l < Gather.txt)"
          echo "文件大小: $(wc -c < Gather.txt) 字节"
        else
          echo "❌ 下载失败，创建空文件"
          echo "#EXTM3U" > Gather.txt
          echo "# 下载失败于 $(date)" >> Gather.txt
        fi

    - name: Setup Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Commit and push
      run: |
        git add Gather.txt
        if ! git diff --staged --quiet; then
          git commit -m "Update TVBOX source - $(date +'%Y-%m-%d %H:%M')"
          git push
          echo "✅ 更新已推送"
        else
          echo "🟡 无变化，跳过提交"
        fi
