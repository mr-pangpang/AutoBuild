name: Update TVBOX Gather Source

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  update-tvbox:
    runs-on: windows-latest
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download TVBOX source
      shell: pwsh
      run: |
        Write-Host "ğŸš€ å¼€å§‹ä¸‹è½½ç›´æ’­æº..."
        
        # ä½¿ç”¨curlä¸‹è½½
        curl -s -L "https://tv-1.iill.top/m3u/Gather" -o Gather.txt
        
        # ä¿®æ­£çš„è¯­æ³•ï¼šåˆ†å¼€åˆ¤æ–­
        if (Test-Path "Gather.txt") {
            $file = Get-Item "Gather.txt"
            if ($file.Length -gt 0) {
                $lineCount = (Get-Content "Gather.txt" | Measure-Object -Line).Lines
                Write-Host "âœ… ä¸‹è½½æˆåŠŸï¼æ–‡ä»¶å…± $lineCount è¡Œ"
                
                # æ˜¾ç¤ºæ–‡ä»¶å¼€å¤´å†…å®¹
                Write-Host "æ–‡ä»¶å¼€å¤´å†…å®¹ï¼š"
                Get-Content "Gather.txt" -First 3 | ForEach-Object { Write-Host "  $_" }
            } else {
                Write-Host "âŒ æ–‡ä»¶ä¸ºç©º"
                Set-Content -Path "Gather.txt" -Value "#EXTM3U`n# ç©ºæ–‡ä»¶ - $(Get-Date)"
            }
        } else {
            Write-Host "âŒ æ–‡ä»¶åˆ›å»ºå¤±è´¥"
            Set-Content -Path "Gather.txt" -Value "#EXTM3U`n# åˆ›å»ºå¤±è´¥ - $(Get-Date)"
        }

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Commit and push
      run: |
        git add Gather.txt
        if ! git diff --staged --quiet; then
          git commit -m "ğŸ“º æ›´æ–°TVBOXç›´æ’­æº $(date +'%Y-%m-%d %H:%M')"
          git push
          echo "âœ… æ›´æ–°å®Œæˆï¼"
        else
          echo "ğŸŸ¡ å†…å®¹æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        fi
