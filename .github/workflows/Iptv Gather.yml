name: TVBOX Source Backup

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  backup:
    runs-on: windows-latest  # 使用Windows环境
    
    permissions:
      contents: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Download using PowerShell
      shell: pwsh
      run: |
        Write-Host "正在下载直播源..."
        try {
          # 使用PowerShell下载
          $url = "https://tv-1.iill.top/m3u/Gather"
          Invoke-WebRequest -Uri $url -OutFile "Gather.txt" -TimeoutSec 30
          
          if (Test-Path "Gather.txt" -And (Get-Item "Gather.txt").Length -gt 0) {
            Write-Host "✅ 下载成功！"
            $lineCount = (Get-Content "Gather.txt" | Measure-Object -Line).Lines
            Write-Host "文件行数: $lineCount"
          } else {
            throw "下载失败"
          }
        }
        catch {
          Write-Host "❌ 下载失败: $($_.Exception.Message)"
          Set-Content -Path "Gather.txt" -Value "#EXTM3U`n# 下载失败于 $(Get-Date)"
        }

    - name: Commit changes
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add Gather.txt
        git commit -m "Update TVBOX source" || echo "无变化"
        git push
