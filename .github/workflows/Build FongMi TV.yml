name: Build and Release FongMi TV

on:
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨æ„å»º
  workflow_dispatch:       # æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout FongMi/TV code
      uses: actions/checkout@v4
      with:
        repository: FongMi/tv
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3

    - name: Make gradlew executable
      run: chmod +x ./gradlew

    - name: Build APK
      run: ./gradlew assembleRelease

    - name: Get build info
      id: build_info
      run: |
        echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
        echo "time=$(date +'%H:%M:%S')" >> $GITHUB_OUTPUT
        echo "version=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: FongMi-TV-${{ steps.build_info.outputs.date }}
        path: app/build/outputs/apk/release/*.apk
        retention-days: 90

    - name: Upload APK to Release
      uses: softprops/action-gh-release@v1
      if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
      with:
        tag_name: nightly-${{ steps.build_info.outputs.date }}
        name: FongMi TV Nightly Build ${{ steps.build_info.outputs.date }}
        body: |
          ğŸš€ è‡ªåŠ¨æ„å»ºçš„ FongMi TV APK

          **æ„å»ºä¿¡æ¯:**
          - æºé¡¹ç›®: [FongMi/tv](https://github.com/FongMi/tv)
          - æ„å»ºæ—¥æœŸ: ${{ steps.build_info.outputs.date }}
          - æ„å»ºæ—¶é—´: ${{ steps.build_info.outputs.time }}
          - è§¦å‘æ–¹å¼: ${{ github.event_name }}

          **ä½¿ç”¨è¯´æ˜:**
          1. ä¸‹è½½ APK æ–‡ä»¶åˆ°æ‚¨çš„ Android TV æˆ–ç›’å­
          2. é€šè¿‡æ–‡ä»¶ç®¡ç†å™¨å®‰è£…
          3. å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒåŸé¡¹ç›®æ–‡æ¡£

          âš ï¸ æ­¤ä¸ºè‡ªåŠ¨æ„å»ºç‰ˆæœ¬ï¼Œéå®˜æ–¹å‘å¸ƒ
        draft: false
        prerelease: true
        files: app/build/outputs/apk/release/*.apk
