name: Build FongMi TV APK

on:
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨æ„å»º
  workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'æ„å»ºç‰ˆæœ¬'
        required: false
        default: 'auto'

env:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    # æ­¥éª¤1: ä¸‹è½½æºä»£ç 
    - name: Download FongMi TV Source Code
      run: |
        echo "æ­£åœ¨ä¸‹è½½ FongMi/TV æºä»£ç ..."
        wget https://github.com/FongMi/tv/archive/refs/heads/main.zip -O source.zip
        unzip -q source.zip
        mv tv-main/* ./
        mv tv-main/.* ./ || true
        ls -la

    # æ­¥éª¤2: è®¾ç½®Javaç¯å¢ƒ
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # æ­¥éª¤3: è®¾ç½®Android SDK
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # æ­¥éª¤4: è®¾ç½®Gradleç¼“å­˜
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: '8.4'

    # æ­¥éª¤5: æˆäºˆæ‰§è¡Œæƒé™
    - name: Make gradlew executable
      run: |
        chmod +x ./gradlew
        ls -la gradlew

    # æ­¥éª¤6: æ£€æŸ¥é¡¹ç›®ç»“æ„
    - name: Check project structure
      run: |
        echo "é¡¹ç›®ç»“æ„:"
        find . -name "*.gradle" -type f | head -10
        find . -name "gradlew" -type f
        echo "Appæ¨¡å—:"
        find . -name "AndroidManifest.xml" -type f | head -5

    # æ­¥éª¤7: æ„å»ºAPK
    - name: Build Release APK
      run: |
        echo "å¼€å§‹æ„å»ºAPK..."
        ./gradlew clean
        ./gradlew assembleRelease --no-daemon --stacktrace
        echo "æ„å»ºå®Œæˆ!"

    # æ­¥éª¤8: æŸ¥æ‰¾ç”Ÿæˆçš„APKæ–‡ä»¶
    - name: Find APK files
      run: |
        echo "æŸ¥æ‰¾APKæ–‡ä»¶..."
        find . -name "*.apk" -type f | while read file; do
          echo "æ‰¾åˆ°APK: $file"
          ls -la "$file"
        done
        
        # æ£€æŸ¥å¸¸è§çš„APKè¾“å‡ºè·¯å¾„
        echo "æ£€æŸ¥æ ‡å‡†è¾“å‡ºç›®å½•:"
        if [ -d "app/build/outputs/apk" ]; then
          find app/build/outputs/apk -name "*.apk" -type f
          ls -la app/build/outputs/apk/ || true
          ls -la app/build/outputs/apk/release/ || true
        fi
        
        if [ -d "build/outputs/apk" ]; then
          find build/outputs/apk -name "*.apk" -type f
        fi

    # æ­¥éª¤9: å‡†å¤‡æ„å»ºä¿¡æ¯
    - name: Setup build info
      id: build_info
      run: |
        BUILD_DATE=$(date +'%Y-%m-%d-%H%M')
        echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥APKæ–‡ä»¶
        if [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
          APK_PATH="app/build/outputs/apk/release/app-release.apk"
        elif [ -f "app/build/outputs/apk/release/app-armeabi-v7a-release.apk" ]; then
          APK_PATH="app/build/outputs/apk/release/app-armeabi-v7a-release.apk"
        else
          # æŸ¥æ‰¾ç¬¬ä¸€ä¸ªAPKæ–‡ä»¶
          APK_PATH=$(find . -name "*.apk" -type f | head -1)
        fi
        
        if [ -n "$APK_PATH" ]; then
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "APKæ–‡ä»¶è·¯å¾„: $APK_PATH"
          ls -la "$APK_PATH"
        else
          echo "æœªæ‰¾åˆ°APKæ–‡ä»¶"
          exit 1
        fi

    # æ­¥éª¤10: ä¸Šä¼ APKåˆ°Artifacts
    - name: Upload APK to Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: FongMi-TV-${{ steps.build_info.outputs.build_date }}
        path: ${{ steps.build_info.outputs.apk_path }}
        retention-days: 90

    # æ­¥éª¤11: åˆ›å»ºGitHub Release (ä»…æ‰‹åŠ¨è§¦å‘æ—¶)
    - name: Create GitHub Release
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: build-${{ steps.build_info.outputs.build_date }}
        name: FongMi TV Build ${{ steps.build_info.outputs.build_date }}
        body: |
          ğŸš€ è‡ªåŠ¨æ„å»ºçš„ FongMi TV APK
          
          **æ„å»ºä¿¡æ¯:**
          - æºé¡¹ç›®: [FongMi/tv](https://github.com/FongMi/tv)
          - æ„å»ºæ—¶é—´: ${{ steps.build_info.outputs.build_date }}
          - è§¦å‘æ–¹å¼: ${{ github.event_name }}
          
          **ä½¿ç”¨è¯´æ˜:**
          1. ä¸‹è½½APKæ–‡ä»¶åˆ°Android TVè®¾å¤‡
          2. å®‰è£…å¹¶è¿è¡Œ
          3. äº«å—è§‚å½±ä½“éªŒ!
          
          > æ­¤ç‰ˆæœ¬ä¸ºè‡ªåŠ¨æ„å»ºï¼Œå¦‚æœ‰é—®é¢˜è¯·å‚è€ƒåŸé¡¹ç›®ã€‚
        files: ${{ steps.build_info.outputs.apk_path }}
        draft: false
        prerelease: false

    # æ­¥éª¤12: æ„å»ºæˆåŠŸé€šçŸ¥
    - name: Build Success
      if: success()
      run: |
        echo "ğŸ‰ APKæ„å»ºæˆåŠŸ!"
        echo "ğŸ“± APKæ–‡ä»¶: ${{ steps.build_info.outputs.apk_path }}"
        echo "ğŸ“¦ å·²ä¸Šä¼ åˆ°Artifacts: FongMi-TV-${{ steps.build_info.outputs.build_date }}"
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "ğŸš€ å·²åˆ›å»ºRelease: build-${{ steps.build_info.outputs.build_date }}"
        fi
