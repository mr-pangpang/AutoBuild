name: Build FongMi TV APK

on:
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨æ„å»º
  workflow_dispatch:       # æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    # æ­¥éª¤1: ä¸‹è½½ fongmi åˆ†æ”¯æºä»£ç 
    - name: Download FongMi TV fongmi branch
      run: |
        echo "æ­£åœ¨ä¸‹è½½ FongMi/TV fongmi åˆ†æ”¯æºä»£ç ..."
        wget https://github.com/FongMi/TV/archive/refs/heads/fongmi.zip -O source.zip
        
        echo "è§£å‹æºä»£ç ..."
        unzip -q source.zip
        
        echo "æŸ¥çœ‹è§£å‹åçš„ç›®å½•ç»“æ„:"
        ls -la
        
        echo "å¤„ç†æ–‡ä»¶..."
        # æ£€æŸ¥è§£å‹åçš„ç›®å½•å
        if [ -d "TV-fongmi" ]; then
          echo "æ‰¾åˆ° TV-fongmi ç›®å½•"
          cp -r TV-fongmi/* ./
          cp -r TV-fongmi/.* ./ 2>/dev/null || true
          rm -rf TV-fongmi
        else
          echo "ç›´æ¥è§£å‹åˆ°å½“å‰ç›®å½•"
        fi
        
        rm -f source.zip
        echo "æœ€ç»ˆç›®å½•ç»“æ„:"
        ls -la

    # æ­¥éª¤2: è®¾ç½®Javaç¯å¢ƒ
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # æ­¥éª¤3: è®¾ç½®Android SDK
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # æ­¥éª¤4: è®¾ç½®Gradle
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: '8.4'

    # æ­¥éª¤5: æˆäºˆæ‰§è¡Œæƒé™
    - name: Make gradlew executable
      run: |
        chmod +x ./gradlew
        echo "Gradle wrapper æƒé™è®¾ç½®å®Œæˆ"

    # æ­¥éª¤6: æ£€æŸ¥é¡¹ç›®ç»“æ„
    - name: Check project structure
      run: |
        echo "=== é¡¹ç›®ç»“æ„æ£€æŸ¥ ==="
        echo "Gradle æ–‡ä»¶:"
        find . -name "*.gradle" -type f | head -5
        echo "æºç ç›®å½•:"
        find . -name "src" -type d | head -3
        echo "æ¸…å•æ–‡ä»¶:"
        find . -name "AndroidManifest.xml" -type f | head -3

    # æ­¥éª¤7: æ„å»ºAPK
    - name: Build Release APK
      run: |
        echo "å¼€å§‹æ„å»ºAPK..."
        ./gradlew clean
        ./gradlew assembleRelease --no-daemon --stacktrace --info
        echo "APKæ„å»ºå®Œæˆ!"

    # æ­¥éª¤8: æŸ¥æ‰¾APKæ–‡ä»¶
    - name: Find APK files
      id: find_apk
      run: |
        echo "=== æŸ¥æ‰¾APKæ–‡ä»¶ ==="
        
        # æŸ¥æ‰¾æ‰€æœ‰APKæ–‡ä»¶
        find . -name "*.apk" -type f | while read file; do
          echo "æ‰¾åˆ°APK: $file"
          ls -la "$file"
        done
        
        # æ£€æŸ¥å¸¸è§çš„APKè¾“å‡ºè·¯å¾„
        echo "æ£€æŸ¥æ ‡å‡†è¾“å‡ºç›®å½•:"
        if [ -d "app/build/outputs/apk" ]; then
          echo "app/build/outputs/apk ç›®å½•å­˜åœ¨"
          find app/build/outputs/apk -name "*.apk" -type f
        fi
        
        if [ -d "build/outputs/apk" ]; then
          echo "build/outputs/apk ç›®å½•å­˜åœ¨"
          find build/outputs/apk -name "*.apk" -type f
        fi
        
        # ç¡®å®šè¦ä½¿ç”¨çš„APKæ–‡ä»¶
        if [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
          APK_PATH="app/build/outputs/apk/release/app-release.apk"
          echo "ä½¿ç”¨æ ‡å‡†Release APK"
        elif [ -f "app/build/outputs/apk/release/app-armeabi-v7a-release.apk" ]; then
          APK_PATH="app/build/outputs/apk/release/app-armeabi-v7a-release.apk"
          echo "ä½¿ç”¨ARMv7 Release APK"
        else
          # æŸ¥æ‰¾ç¬¬ä¸€ä¸ªrelease APK
          APK_PATH=$(find . -name "*release*.apk" -type f | head -1)
          if [ -n "$APK_PATH" ]; then
            echo "ä½¿ç”¨æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªRelease APK: $APK_PATH"
          else
            # æŸ¥æ‰¾ä»»ä½•APKæ–‡ä»¶
            APK_PATH=$(find . -name "*.apk" -type f | head -1)
            if [ -n "$APK_PATH" ]; then
              echo "ä½¿ç”¨æ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªAPK: $APK_PATH"
            fi
          fi
        fi
        
        if [ -n "$APK_PATH" ] && [ -f "$APK_PATH" ]; then
          echo "æœ€ç»ˆAPKè·¯å¾„: $APK_PATH"
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          
          # å¤åˆ¶å¹¶é‡å‘½åAPKæ–‡ä»¶
          cp "$APK_PATH" "./FongMi-TV-fongmi.apk"
          echo "é‡å‘½åå®Œæˆ"
        else
          echo "é”™è¯¯: æœªæ‰¾åˆ°ä»»ä½•APKæ–‡ä»¶"
          echo "è¯¦ç»†ç›®å½•ç»“æ„:"
          find . -name "build" -type d
          exit 1
        fi

    # æ­¥éª¤9: å‡†å¤‡æ„å»ºä¿¡æ¯
    - name: Setup build info
      id: build_info
      run: |
        BUILD_DATE=$(date +'%Y-%m-%d-%H%M')
        echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
        echo "branch=fongmi" >> $GITHUB_OUTPUT

    # æ­¥éª¤10: ä¸Šä¼ APKåˆ°Artifacts
    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: FongMi-TV-fongmi-${{ steps.build_info.outputs.build_date }}
        path: FongMi-TV-fongmi.apk
        retention-days: 90

    # æ­¥éª¤11: åˆ›å»ºGitHub Releaseï¼ˆæ‰‹åŠ¨è§¦å‘æ—¶ï¼‰
    - name: Create GitHub Release
      if: github.event_name == 'workflow_dispatch'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: fongmi-build-${{ steps.build_info.outputs.build_date }}
        name: FongMi TV (fongmiåˆ†æ”¯) Build ${{ steps.build_info.outputs.build_date }}
        body: |
          ğŸš€ è‡ªåŠ¨æ„å»ºçš„ FongMi TV APK - fongmi åˆ†æ”¯
          
          **æ„å»ºä¿¡æ¯:**
          - æºé¡¹ç›®: [FongMi/TV](https://github.com/FongMi/TV/tree/fongmi)
          - åˆ†æ”¯: fongmi
          - æ„å»ºæ—¶é—´: ${{ steps.build_info.outputs.build_date }}
          - è§¦å‘æ–¹å¼: æ‰‹åŠ¨è§¦å‘
          
          **ä¸‹è½½è¯´æ˜:**
          1. ç‚¹å‡»ä¸‹æ–¹çš„ APK æ–‡ä»¶ä¸‹è½½
          2. ä¼ è¾“åˆ° Android TV/æ‰‹æœºè®¾å¤‡
          3. å®‰è£…å¹¶äº«å—è§‚å½±ä½“éªŒ
          
          **æ³¨æ„äº‹é¡¹:**
          - æ­¤ä¸ºè‡ªåŠ¨æ„å»ºç‰ˆæœ¬ï¼Œéå®˜æ–¹å‘å¸ƒ
          - åŸºäº fongmi åˆ†æ”¯æœ€æ–°ä»£ç æ„å»º
          - å¦‚æœ‰é—®é¢˜è¯·å‚è€ƒåŸé¡¹ç›®
        files: FongMi-TV-fongmi.apk
        draft: false
        prerelease: false

    # æ­¥éª¤12: æ„å»ºæˆåŠŸé€šçŸ¥
    - name: Build success notification
      if: success()
      run: |
        echo "ğŸ‰ FongMi TV (fongmiåˆ†æ”¯) APK æ„å»ºæˆåŠŸ!"
        echo "ğŸ“± APK æ–‡ä»¶: FongMi-TV-fongmi.apk"
        echo "ğŸ“¦ å·²ä¸Šä¼ åˆ° Artifacts: FongMi-TV-fongmi-${{ steps.build_info.outputs.build_date }}"
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "ğŸš€ å·²åˆ›å»º GitHub Release: fongmi-build-${{ steps.build_info.outputs.build_date }}"
        fi
        echo "ğŸ”— æºä»£ç : https://github.com/FongMi/TV/tree/fongmi"
