name: Build and Auto Release

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 添加这个权限
    
    steps:
    - name: Checkout FongMi/TV code
      uses: actions/checkout@v4
      with:
        repository: FongMi/tv

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Build APK
      run: |
        chmod +x ./gradlew
        ./gradlew assembleRelease

    - name: Get version info
      id: version
      run: |
        BUILD_DATE=$(date +'%Y-%m-%d')
        BUILD_TIME=$(date +'%H%M')
        echo "BUILD_DATE=$BUILD_DATE" >> $GITHUB_ENV
        echo "BUILD_TIME=$BUILD_TIME" >> $GITHUB_ENV
        echo "tag=nightly-$BUILD_DATE-$BUILD_TIME" >> $GITHUB_OUTPUT

    - name: Create GitHub Release
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ steps.version.outputs.tag }}
        name: "FongMi TV Nightly ${{ env.BUILD_DATE }}"
        body: |
          ### 自动夜间构建

          **构建信息**
          - 构建日期: ${{ env.BUILD_DATE }}
          - 构建时间: ${{ env.BUILD_TIME }}
          - 源仓库: [FongMi/tv](https://github.com/FongMi/tv)

          **下载说明**
          点击下方的 APK 文件下载安装

          > ⚠️ 注意：此为自动构建版本，稳定性请自行测试
        artifacts: "app/build/outputs/apk/release/*.apk"
        draft: false
        prerelease: true
        token: ${{ secrets.GITHUB_TOKEN }}
