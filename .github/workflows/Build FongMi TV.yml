name: Build FongMi TV APK

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:       # 手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # 步骤1: 下载 fongmi 分支源代码
    - name: Download FongMi TV fongmi branch
      run: |
        echo "正在下载 FongMi/TV fongmi 分支源代码..."
        wget https://github.com/FongMi/TV/archive/refs/heads/fongmi.zip -O source.zip
        
        echo "解压源代码..."
        unzip -q source.zip
        
        echo "处理文件..."
        if [ -d "TV-fongmi" ]; then
          echo "找到 TV-fongmi 目录"
          cp -r TV-fongmi/* ./
          cp -r TV-fongmi/.* ./ 2>/dev/null || true
          rm -rf TV-fongmi
        fi
        
        rm -f source.zip
        echo "目录结构:"
        ls -la

    # 步骤2: 设置Java环境
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # 步骤3: 设置Android SDK
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    # 步骤4: 设置Gradle
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v3

    # 步骤5: 授予执行权限
    - name: Make gradlew executable
      run: chmod +x ./gradlew

    # 步骤6: 检查Gradle配置
    - name: Check Gradle configuration
      run: |
        echo "=== Gradle 配置检查 ==="
        ./gradlew --version
        echo "Gradle 任务列表:"
        ./gradlew tasks --all || true

    # 步骤7: 尝试不同的构建方式
    - name: Build with detailed logging
      id: build
      run: |
        echo "=== 开始构建APK ==="
        
        # 尝试清理项目
        echo "1. 清理项目..."
        ./gradlew clean --no-daemon --stacktrace || echo "清理完成"
        
        # 尝试不同的构建命令
        echo "2. 尝试 assembleRelease..."
        ./gradlew assembleRelease --no-daemon --stacktrace --warning-mode all --scan || \
        (echo "assembleRelease 失败，尝试 assembleDebug..." && \
         ./gradlew assembleDebug --no-daemon --stacktrace --warning-mode all) || \
        (echo "所有构建尝试失败" && exit 1)
        
        echo "构建过程完成"

    # 步骤8: 查找APK文件
    - name: Find APK files
      if: success()
      id: find_apk
      run: |
        echo "=== 查找APK文件 ==="
        
        # 查找所有APK文件
        find . -name "*.apk" -type f | while read file; do
          echo "找到APK: $file (大小: $(ls -lh "$file" | awk '{print $5}'))"
        done
        
        # 确定APK文件
        if [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
          APK_PATH="app/build/outputs/apk/release/app-release.apk"
        elif [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
          APK_PATH="app/build/outputs/apk/debug/app-debug.apk"
        else
          APK_PATH=$(find . -name "*.apk" -type f | head -1)
        fi
        
        if [ -n "$APK_PATH" ] && [ -f "$APK_PATH" ]; then
          echo "使用APK: $APK_PATH"
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          cp "$APK_PATH" "./FongMi-TV.apk"
        else
          echo "未找到APK文件"
          exit 1
        fi

    # 步骤9: 上传APK
    - name: Upload APK artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: FongMi-TV-fongmi
        path: FongMi-TV.apk
        retention-days: 90

    # 步骤10: 构建失败时的诊断信息
    - name: Build failure diagnostics
      if: failure()
      run: |
        echo "=== 构建失败诊断信息 ==="
        echo "检查构建目录:"
        find . -name "build" -type d | head -5
        echo "检查错误日志:"
        find . -name "*.log" -type f | head -10
        echo "Gradle 属性:"
        find . -name "gradle.properties" -type f | head -3
        echo "项目模块:"
        find . -name "build.gradle" -type f | head -5
