name: Build FongMi TV

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout FongMi/TV code
      uses: actions/checkout@v4
      with:
        repository: FongMi/tv
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Debug - List files
      run: |
        echo "当前目录结构:"
        ls -la
        echo "app目录结构:"
        ls -la app/ || echo "没有app目录"
        echo "查找gradlew文件:"
        find . -name "gradlew" -type f 2>/dev/null || echo "未找到gradlew文件"

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Check and fix gradlew
      run: |
        if [ ! -f "./gradlew" ]; then
          echo "gradlew不存在，尝试生成..."
          # 检查是否有gradle wrapper
          if [ -f "gradle/wrapper/gradle-wrapper.jar" ]; then
            echo "使用gradle命令生成wrapper"
            ./gradlew tasks || chmod +x gradlew || gradle wrapper
          else
            echo "生成gradle wrapper"
            gradle wrapper
          fi
        fi
        chmod +x ./gradlew || echo "无法设置gradlew权限"

    - name: Build APK
      run: |
        # 尝试不同的构建命令
        if [ -f "./gradlew" ]; then
          ./gradlew assembleRelease
        else
          echo "使用系统gradle构建"
          gradle assembleRelease
        fi

    - name: Upload APK artifact
      uses: actions/upload-artifact@v4
      with:
        name: FongMi-TV
        path: |
          app/build/outputs/apk/**/*.apk
          */build/outputs/apk/**/*.apk
        retention-days: 30
