name: disk_livepy
on:
  schedule:
    - cron: "0 */2 * * *"
  workflow_dispatch:

jobs:
  download-and-save:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install requests if needed
        run: pip install requests

      - name: Run remote script and save output
        run: |
          # èŽ·å–è¿œç¨‹è„šæœ¬å¹¶æ‰§è¡Œï¼Œå°†è¾“å‡ºä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶
          curl -s https://raw.githubusercontent.com/mr-pangpang/AutoBuild/main/script/live.py | python > temp_output.txt
          
          # ä½¿ç”¨ sed åˆ é™¤åŒ…å«ç‰¹å®šå…³é”®è¯çš„è¡Œ
          sed -e '/æ­£åœ¨è§£å¯†:/d' \
              -e '/åŽŸå§‹å†…å®¹é•¿åº¦:/d' \
              -e '/æ¸…ç†æ³¨é‡ŠåŽé•¿åº¦:/d' \
              -e '/æ­£åœ¨åˆ é™¤å­—æ®µ:/d' \
              -e '/å·²åˆ é™¤å­—æ®µ:/d' \
              -e '/åˆ é™¤ç©ºç™½è¡Œ:/d' \
              -e '/âœ… å·²æ·»åŠ è‡ªå®šä¹‰å­—æ®µ/d' \
              -e '/æœ€ç»ˆå†…å®¹é•¿åº¦:/d' \
              -e '/==================================================/d' \
              -e '/è§£å¯†åŽçš„å†…å®¹:/d' \
              temp_output.txt > temp_output_cleaned.txt

      - name: Move "æˆ‘çš„å¤¸å…‹" after "æœ¬åœ°æ’­æ”¾"
        run: |
          # è¯»å–æ¸…ç†åŽçš„æ–‡ä»¶å†…å®¹
          content=$(cat temp_output_cleaned.txt)
          
          # æ£€æŸ¥æ˜¯å¦åŒ…å«"æˆ‘çš„å¤¸å…‹"
          if echo "$content" | grep -q '{"key":"æˆ‘çš„å¤¸å…‹"'; then
            # æå–"æˆ‘çš„å¤¸å…‹"éƒ¨åˆ†ï¼ˆå®Œæ•´çš„ä¸€è¡Œï¼‰
            my_quark_line=$(echo "$content" | grep '{"key":"æˆ‘çš„å¤¸å…‹"')
            
            # ä»ŽåŽŸå†…å®¹ä¸­åˆ é™¤"æˆ‘çš„å¤¸å…‹"è¡Œ
            content_without_quark=$(echo "$content" | grep -v '{"key":"æˆ‘çš„å¤¸å…‹"')
          else
            # å¦‚æžœä¸å­˜åœ¨ï¼Œåˆ›å»º"æˆ‘çš„å¤¸å…‹"è¡Œ
            my_quark_line='{"key":"æˆ‘çš„å¤¸å…‹","name":"ðŸ—½æˆ‘çš„â”ƒå¤¸å…‹","type":3,"api":"csp_MyQuarkGuard","searchable":0,"quickSearch":0,"changeable":0,"filterable":0,"indexs":0,"style":{"type":"list"},"timeout":30},'
            content_without_quark="$content"
          fi
          
          # åœ¨"æœ¬åœ°æ’­æ”¾"åŽé¢æ’å…¥"æˆ‘çš„å¤¸å…‹"è¡Œ
          echo "$content_without_quark" | python3 -c "
import sys

content = sys.stdin.read()
lines = content.split('\n')

# æ‰¾åˆ°æœ¬åœ°æ’­æ”¾çš„ä½ç½®
local_play_index = -1
for i, line in enumerate(lines):
    if '\"key\":\"æœ¬åœ°æ’­æ”¾\"' in line:
        local_play_index = i
        break

# æ‰¾åˆ°æœ¬åœ°æ’­æ”¾å—çš„ç»“æŸä½ç½®
if local_play_index != -1:
    brace_count = 0
    in_local_play = False
    end_index = -1
    
    for i in range(local_play_index, len(lines)):
        line = lines[i]
        if '\"key\":\"æœ¬åœ°æ’­æ”¾\"' in line:
            in_local_play = True
        
        if in_local_play:
            brace_count += line.count('{')
            brace_count -= line.count('}')
            
            if brace_count == 0 and in_local_play:
                end_index = i
                break
    
    if end_index != -1:
        # åœ¨æœ¬åœ°æ’­æ”¾ç»“æŸåŽæ’å…¥æˆ‘çš„å¤¸å…‹
        lines.insert(end_index + 1, '$my_quark_line')
        print('\n'.join(lines))
    else:
        print(content)
else:
    print(content)
" > live
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f temp_output.txt temp_output_cleaned.txt

      - id: check_repo
        run: |
          RESPONSE=$(curl -s -w "%{http_code}" -H "Authorization: token ${{ secrets.PANGPANG }}" "https://api.github.com/repos/dpdisk/m3u")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          echo "repo_exists=$([ "$HTTP_CODE" -eq 200 ] && echo "true" || echo "false")" >> $GITHUB_OUTPUT

      - if: steps.check_repo.outputs.repo_exists == 'false'
        run: |
          curl -X POST -H "Authorization: token ${{ secrets.PANGPANG }}" -H "Content-Type: application/json" -d '{"name":"m3u","auto_init":false,"visibility":"public"}' "https://api.github.com/user/repos"

      - run: |
          git clone -b main --single-branch https://${{ secrets.PANGPANG }}@github.com/dpdisk/m3u.git target-repo || (mkdir -p target-repo && cd target-repo && git init && git remote add origin https://${{ secrets.PANGPANG }}@github.com/dpdisk/m3u.git && git checkout -b main)

      - run: |
          mv live target-repo/

      - run: |
          cd target-repo
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add live
          CURRENT_TIME=$(date -d "+8 hours" +'%Y-%m-%d %H:%M:%S')
          git commit -m "updatetime $CURRENT_TIME" || true
          git push https://${{ secrets.PANGPANG }}@github.com/dpdisk/m3u.git HEAD:main
