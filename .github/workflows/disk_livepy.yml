name: disk_livepy
on:
  schedule:
    - cron: "0 */2 * * *"
  workflow_dispatch:

jobs:
  download-and-save:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install requests if needed
        run: pip install requests

      - name: Run remote script and save output
        run: |
          # 获取远程脚本并执行，将输出保存到临时文件
          curl -s https://raw.githubusercontent.com/mr-pangpang/AutoBuild/main/script/live.py | python > temp_output.txt
          
          # 使用 sed 删除包含特定关键词的行
          sed -e '/正在解密:/d' \
              -e '/原始内容长度:/d' \
              -e '/清理注释后长度:/d' \
              -e '/正在删除字段:/d' \
              -e '/已删除字段:/d' \
              -e '/删除空白行:/d' \
              -e '/✅ 已添加自定义字段/d' \
              -e '/最终内容长度:/d' \
              -e '/==================================================/d' \
              -e '/解密后的内容:/d' \
              temp_output.txt > temp_cleaned.txt

      - name: Move "我的夸克" after "本地播放"
        run: |
          # 读取清理后的文件内容
          content=$(cat temp_cleaned.txt)
          
          # 提取"我的夸克"行
          my_quark_line=$(echo "$content" | grep '{"key":"我的夸克"')
          
          if [ -n "$my_quark_line" ]; then
            # 先删除"我的夸克"行
            content_without_quark=$(echo "$content" | sed '/{"key":"我的夸克"/d')
            
            # 在"本地播放"后面插入"我的夸克"
            # 找到"本地播放"块结束的位置（在"二小弹幕"之前）
            echo "$content_without_quark" | awk -v quark="$my_quark_line" '
              /{"key":"二小弹幕"/ {
                print quark
              }
              { print }
            ' | awk '
              /{"key":"二小弹幕"/ {
                found_erxiao = 1
              }
              found_erxiao && !quark_printed {
                print "'"$my_quark_line"'"
                quark_printed = 1
              }
              { print }
            ' > temp_final.txt
            
            # 再次处理，确保只在二小弹幕前插入一次
            mv temp_final.txt live
          else
            cp temp_cleaned.txt live
          fi
          
          # 清理临时文件
          rm -f temp_output.txt temp_cleaned.txt temp_final.txt

      - id: check_repo
        run: |
          RESPONSE=$(curl -s -w "%{http_code}" -H "Authorization: token ${{ secrets.PANGPANG }}" "https://api.github.com/repos/dpdisk/m3u")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          echo "repo_exists=$([ "$HTTP_CODE" -eq 200 ] && echo "true" || echo "false")" >> $GITHUB_OUTPUT

      - if: steps.check_repo.outputs.repo_exists == 'false'
        run: |
          curl -X POST -H "Authorization: token ${{ secrets.PANGPANG }}" -H "Content-Type: application/json" -d '{"name":"m3u","auto_init":false,"visibility":"public"}' "https://api.github.com/user/repos"

      - run: |
          git clone -b main --single-branch https://${{ secrets.PANGPANG }}@github.com/dpdisk/m3u.git target-repo || (mkdir -p target-repo && cd target-repo && git init && git remote add origin https://${{ secrets.PANGPANG }}@github.com/dpdisk/m3u.git && git checkout -b main)

      - run: |
          mv live target-repo/

      - run: |
          cd target-repo
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add live
          CURRENT_TIME=$(date -d "+8 hours" +'%Y-%m-%d %H:%M:%S')
          git commit -m "updatetime $CURRENT_TIME" || true
          git push https://${{ secrets.PANGPANG }}@github.com/dpdisk/m3u.git HEAD:main
