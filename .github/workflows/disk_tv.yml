name: disk_tv
on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  download-merge-clean-save-tv:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–å½“å‰ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: ä¸‹è½½è™ç‰™æº
        run: |
          curl -f -o huyta "https://raw.githubusercontent.com/mr-pangpang/m3u/refs/heads/main/huya"
          echo "huya æºæ–‡ä»¶ä¸‹è½½å®Œæˆï¼Œå¤§å°ï¼š$(du -h huyta)"

      - name: ä¸‹è½½å’ªè§†ç•Œæº
        run: |
          curl -f -o migu_sports "https://raw.githubusercontent.com/YanG-1989/m3u/refs/heads/main/Migu.m3u"
          echo "migu_sports æºæ–‡ä»¶ä¸‹è½½å®Œæˆï¼Œå¤§å°ï¼š$(du -h migu_sports)"

      - name: ä¸‹è½½å’ªå’•è§†é¢‘æº
        run: |
          curl -f -o migu_video "https://raw.githubusercontent.com/develop202/migu_video/main/interface.txt"
          echo "migu_video æºæ–‡ä»¶ä¸‹è½½å®Œæˆï¼Œå¤§å°ï¼š$(du -h migu_video)"

      - name: åˆå¹¶æºæ–‡ä»¶
        run: |
          cat huyta migu_sports migu_video > tv_temp
          echo "æºæ–‡ä»¶åˆå¹¶å®Œæˆï¼Œä¸´æ—¶æ–‡ä»¶å¤§å°ï¼š$(du -h tv_temp)"

      - name: æ¸…ç†æ­¥éª¤1 - åˆ é™¤ svg-id å’Œ svg-name å­—æ®µï¼ˆåŒ¹é… "svg-id='xxx' svg-name='xxx'" æ ¼å¼ï¼‰
        run: |
          sed -i -E 's/(svg-id=("([^"]*)"|'\''([^'\'']*)'\''))[[:space:]]*(svg-name=("([^"]*)"|'\''([^'\'']*)'\''))//g' tv_temp
          sed -i -E 's/(svg-id=("([^"]*)"|'\''([^'\'']*)'\''))//g' tv_temp
          sed -i -E 's/(svg-name=("([^"]*)"|'\''([^'\'']*)'\''))//g' tv_temp
          echo "å·²åˆ é™¤æ‰€æœ‰ svg-id å’Œ svg-name å­—æ®µ"

      - name: æ¸…ç†æ­¥éª¤2 - åˆ é™¤ tvg-id å­—æ®µ
        run: |
          sed -i -E 's/(tvg-id=("([^"]*)"|'\''([^'\'']*)'\''))//g' tv_temp
          echo "å·²åˆ é™¤æ‰€æœ‰ tvg-id å­—æ®µ"

      - name: æ¸…ç†æ­¥éª¤3 - åˆ é™¤ tvg-name å­—æ®µ
        run: |
          sed -i -E 's/(tvg-name=("([^"]*)"|'\''([^'\'']*)'\''))//g' tv_temp
          echo "å·²åˆ é™¤æ‰€æœ‰ tvg-name å­—æ®µ"

      - name: æ¸…ç†æ­¥éª¤4 - æ›¿æ¢ group-title å¹¶åˆ é™¤ç‰¹å®šæ‹¬å·å†…å®¹
        run: |
          # 1. å°† group-title="â€¢å’ªå’•ã€Œç§»åŠ¨ã€" å’Œ group-title="â€¢å’ªå’•ã€Œç½‘Â·â… ã€" ç»Ÿä¸€æ”¹ä¸º group-title="å’ªè§†ç•Œ"
          sed -i -E 's/group-title="â€¢å’ªå’•ã€Œ(ç§»åŠ¨|ç½‘Â·â… )ã€"/group-title="å’ªè§†ç•Œ"/g' tv_temp
          # 2. åˆ é™¤é¢‘é“åç§°ä¸­çš„ã€Œç§»åŠ¨ã€ã€ŒIPV4ã€ï¼ˆåŒ¹é… " ğŸ›ğŸŸã€Œç§»åŠ¨ã€" " ğŸ ã€ŒIPV4ã€" ç­‰æ ¼å¼ï¼Œä¿ç•™æ•°å­—å’Œåç§°ä¸»ä½“ï¼‰
          sed -i -E 's/([0-9ğŸ˜-ğŸ¿]+)ã€Œ(ç§»åŠ¨|IPV4)ã€/\1/' tv_temp
          # 3. ä¿ç•™åŸæœ‰çš„æ ¼å¼ä¼˜åŒ–ï¼ˆå»å¤šä½™ç©ºæ ¼ã€ç©ºè¡Œï¼‰
          sed -i -e 's/  */ /g' -e 's/^ //' -e 's/ $//' -e '/^$/d' tv_temp
          mv tv_temp tv
          echo "æ ¼å¼ä¼˜åŒ–ã€group-titleæ›¿æ¢åŠæ‹¬å·å†…å®¹åˆ é™¤å®Œæˆï¼Œæœ€ç»ˆ tv æ–‡ä»¶å¤§å°ï¼š$(du -h tv)"

      - name: æ£€æŸ¥ dpdisk/file ä»“åº“æ˜¯å¦å­˜åœ¨
        id: check_repo
        run: |
          RESPONSE=$(curl -s -w "%{http_code}" -H "Authorization: token ${{ secrets.PANGPANG }}" "https://api.github.com/repos/dpdisk/file")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          echo "repo_exists=$([ "$HTTP_CODE" -eq 200 ] && echo "true" || echo "false")" >> $GITHUB_OUTPUT

      - name: è‹¥ä»“åº“ä¸å­˜åœ¨åˆ™åˆ›å»º
        if: steps.check_repo.outputs.repo_exists == 'false'
        run: |
          curl -X POST -H "Authorization: token ${{ secrets.PANGPANG }}" -H "Content-Type: application/json" -d '{"name":"file","auto_init":false,"visibility":"public"}' "https://api.github.com/user/repos"

      - name: å…‹éš†ä»“åº“å¹¶æ¨é€æ–‡ä»¶
        run: |
          git clone -b main --single-branch https://${{ secrets.PANGPANG }}@github.com/dpdisk/file.git target-repo || (mkdir -p target-repo && cd target-repo && git init && git remote add origin https://${{ secrets.PANGPANG }}@github.com/dpdisk/file.git && git checkout -b main)
          mv tv target-repo/
          cd target-repo
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add tv
          CURRENT_TIME=$(date -d "+8 hours" +'%Y-%m-%d %H:%M:%S')
          git commit -m "updatetime $CURRENT_TIME" || echo "æ— å˜æ›´æ— éœ€æäº¤"
          git push https://${{ secrets.PANGPANG }}@github.com/dpdisk/file.git HEAD:main
